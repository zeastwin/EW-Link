@page "/resources"
@model EW_Link.Pages.Resources.IndexModel
@using EW_Link.Services
@{
    ViewData["Title"] = "EW-Link";
    string ActiveTab(ResourceTab tab) => Model.SelectedTab == tab ? "active" : string.Empty;
    var currentPathDisplay = string.IsNullOrWhiteSpace(Model.CurrentPath) ? "/" : Model.CurrentPath;
}

<div id="resource-page-content" class="resource-shell">
    <section class="glass-panel shadow-sm">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
            <div class="d-flex align-items-center gap-2">
                <a class="badge rounded-pill resource-tab-link tab-chip tab-chip-strong @ActiveTab(ResourceTab.Temporary)"
                   asp-page="/Resources/Index"
                   asp-route-tab="temporary"
                   asp-route-path="@Model.CurrentPath"
                   asp-route-q="@Model.Filter"
                   asp-route-sort="@Model.SortFieldParam"
                   asp-route-dir="@Model.SortDirectionParam"
                   asp-route-view="@(Model.IsTrashView ? "trash" : null)">ä¸´æ—¶æ–‡ä»¶å¤¹</a>
                <a class="badge rounded-pill resource-tab-link tab-chip tab-chip-strong @ActiveTab(ResourceTab.Permanent)"
                   asp-page="/Resources/Index"
                   asp-route-tab="permanent"
                   asp-route-path="@Model.CurrentPath"
                   asp-route-q="@Model.Filter"
                   asp-route-sort="@Model.SortFieldParam"
                   asp-route-dir="@Model.SortDirectionParam"
                   asp-route-view="@(Model.IsTrashView ? "trash" : null)">æ°¸ä¹…æ–‡ä»¶å¤¹</a>
            </div>
            <div class="text-end small text-muted">
                <span class="me-3">ç›®å½•æ•°ï¼š@Model.DirectoryCount</span>
                <span class="me-3">æ–‡ä»¶æ•°ï¼š@Model.FileCount</span>
                <span>æ€»å¤§å°ï¼š@Model.FormatSize(Model.TotalSize)</span>
            </div>
        </div>
        @if (Model.SelectedTab == ResourceTab.Temporary)
        {
            <div class="text-muted small mb-3">æç¤ºï¼šä¸´æ—¶æ–‡ä»¶å¤¹ç”¨äºä¸´æ—¶ä¼ é€’æ–‡ä»¶ï¼Œè¶…è¿‡ 72 å°æ—¶å°†è‡ªåŠ¨æ¸…ç†ã€‚</div>
        }

        @if (TempData["SuccessMessage"] is string successMessage)
        {
            <div class="alert alert-success" role="alert">
                @successMessage
            </div>
        }
        @if (TempData["ErrorMessage"] is string errorMessage)
        {
            <div class="alert alert-danger" role="alert">
                @errorMessage
            </div>
        }
        @if (!ViewData.ModelState.IsValid)
        {
            <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>
        }

        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3 breadcrumb-bar">
            <div class="text-muted small">è·¯å¾„ï¼š@currentPathDisplay</div>
            @if (!Model.IsTrashView)
            {
                <a class="btn btn-outline-light border btn-sm ms-auto text-muted"
                   asp-page="/Resources/Index"
                   asp-route-tab="@Model.SelectedTabString"
                   asp-route-view="trash">å›æ”¶ç«™</a>
            }
        </div>

        @if (Model.IsTrashView)
        {
            <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                <a class="btn btn-return btn-sm"
                   asp-page="/Resources/Index"
                   asp-route-tab="@Model.SelectedTabString"
                   asp-route-view="">â¬… è¿”å›åˆ—è¡¨</a>
                <button type="button" class="btn btn-primary" id="restore-selected-btn" disabled>è¿˜åŸ</button>
                <button type="button" class="btn btn-outline-danger" id="purge-selected-btn" disabled>å½»åº•åˆ é™¤</button>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="select-all" />
                    <label class="form-check-label" for="select-all">å…¨é€‰</label>
                </div>
            </div>

            <div class="list-group resource-list">
                @if (Model.TrashEntries.Count == 0)
                {
                    <div class="list-group-item text-center text-muted py-4">å›æ”¶ç«™ä¸ºç©º</div>
                }
                else
                {
                    @foreach (var entry in Model.TrashEntries)
                    {
                        <div class="list-group-item d-flex align-items-center gap-3">
                            <div class="form-check">
                                <input class="form-check-input entry-checkbox" type="checkbox" name="ids" value="@entry.Id" />
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="resource-icon">@((entry.IsDirectory ? "ğŸ“" : "ğŸ“„"))</span>
                                    <span class="fw-semibold text-primary">@entry.Name</span>
                                </div>
                                <div class="text-muted small">
                                    <span>åŸè·¯å¾„ï¼š@entry.OriginalPath</span>
                                    <span class="ms-3">åˆ é™¤æ—¶é—´ï¼š@entry.DeletedAt.ToLocalTime().ToString("yyyy/MM/dd HH:mm")</span>
                                    <span class="ms-3">å¤§å°ï¼š@Model.FormatSize(entry.SizeBytes)</span>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        }
        else
        {
        <div class="action-panel row g-3 mb-3 align-items-center">
            <div class="col-12 col-lg-7 d-flex flex-wrap align-items-center gap-2">
                <form id="upload-form" method="post" enctype="multipart/form-data" asp-page-handler="Upload" class="d-flex flex-wrap align-items-center gap-2 flex-grow-1">
                    <input type="hidden" name="tab" value="@Model.SelectedTabString" />
                    <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
                    <input type="hidden" name="q" value="@Model.Filter" />
                    <input type="hidden" name="sort" value="@Model.SortFieldParam" />
                    <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
                    <input type="hidden" name="view" value="@(Model.IsTrashView ? "trash" : string.Empty)" />
                    <div class="input-group flex-grow-1" id="upload-drop-target">
                        <input type="file" name="files" id="upload-file" class="form-control" multiple />
                        <input type="file" id="upload-folder" class="d-none" webkitdirectory directory multiple />
                        <label class="btn btn-outline-secondary px-3" for="upload-folder">é€‰æ‹©æ–‡ä»¶å¤¹</label>
                        <button type="submit" class="btn btn-success px-3" id="upload-submit">ä¸Šä¼ </button>
                    </div>
                </form>
            </div>
            <div class="col-12 col-lg-5">
                <form id="sort-form" method="get" class="d-flex flex-wrap align-items-center gap-2 justify-content-lg-end">
                    <input type="hidden" name="tab" value="@Model.SelectedTabString" />
                    <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
                    <input type="hidden" id="sort-hidden" name="sort" value="@Model.SortFieldParam" />
                    <input type="hidden" id="dir-hidden" name="dir" value="@Model.SortDirectionParam" />
                    <input class="form-control search-compact" type="search" name="q" placeholder="æ–‡ä»¶åè¿‡æ»¤" value="@Model.Filter" />
                </form>
            </div>
        </div>

        <form id="create-folder-form" method="post" asp-page-handler="CreateDirectory" class="d-none">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
            <input type="hidden" name="q" value="@Model.Filter" />
            <input type="hidden" name="sort" value="@Model.SortFieldParam" />
            <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
            <input type="hidden" name="view" value="@(Model.IsTrashView ? "trash" : string.Empty)" />
            <input type="hidden" id="create-folder-name" name="folderName" />
        </form>

        <form method="post" asp-page-handler="DownloadZip" id="zip-form" class="resource-list-form">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
            <input type="hidden" name="q" value="@Model.Filter" />
            <input type="hidden" name="sort" value="@Model.SortFieldParam" />
            <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
            <input type="hidden" id="dirs-endpoint" value="@Url.Page("/Resources/Index", "Dirs", new { tab = Model.SelectedTabString })" />
            <input type="hidden" name="view" value="@(Model.IsTrashView ? "trash" : string.Empty)" />

            <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                <a class="btn btn-return btn-sm back-link"
                   href="@Url.Page("/Resources/Index", new { tab = Model.SelectedTabString, path = Model.ParentPath, q = Model.Filter, sort = Model.SortFieldParam, dir = Model.SortDirectionParam })">â¬… è¿”å›</a>
                <button type="button" class="btn btn-primary" id="download-zip-btn" disabled>æ‰¹é‡ä¸‹è½½ ZIP (0)</button>
                <button type="button" class="btn btn-outline-primary" id="share-selected-btn" disabled>åˆ†äº«</button>
                <button type="button" class="btn btn-outline-danger" id="delete-selected-btn" disabled>åˆ é™¤</button>
                <button type="button" class="btn btn-outline-secondary" id="move-selected-btn" disabled>ç§»åŠ¨</button>
                <button type="button" class="btn btn-outline-secondary" id="rename-selected-btn" disabled>é‡å‘½å</button>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="select-all" />
                    <label class="form-check-label" for="select-all">å…¨é€‰</label>
                </div>
                <button type="button" id="create-folder-btn" class="btn btn-outline-primary btn-sm">æ–°å»ºæ–‡ä»¶å¤¹</button>
                <div class="d-flex flex-wrap align-items-center gap-2 ms-auto">
                    <div class="btn-group compact-group" role="group" aria-label="Sort">
                        <button type="button" data-sort="name" class="btn btn-outline-primary sort-btn @(Model.SortFieldParam=="name"?"active":"")">åç§°</button>
                        <button type="button" data-sort="time" class="btn btn-outline-primary sort-btn @(Model.SortFieldParam=="time"?"active":"")">æ—¶é—´</button>
                        <button type="button" data-sort="size" class="btn btn-outline-primary sort-btn @(Model.SortFieldParam=="size"?"active":"")">å¤§å°</button>
                    </div>
                    <div class="btn-group compact-group" role="group" aria-label="Dir">
                        <button type="button" data-dir="asc" class="btn btn-outline-secondary dir-btn @(Model.SortDirectionParam=="asc"?"active":"")">å‡</button>
                        <button type="button" data-dir="desc" class="btn btn-outline-secondary dir-btn @(Model.SortDirectionParam=="desc"?"active":"")">é™</button>
                    </div>
                </div>
            </div>

            <div id="upload-status" class="alert d-none" role="alert"></div>
            <div id="upload-progress-container" class="d-none mb-3 d-flex align-items-center gap-2">
                <div class="progress flex-grow-1">
                    <div id="upload-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm d-none" id="upload-cancel" title="åœæ­¢ä¸Šä¼ ">âœ•</button>
                <span id="upload-speed" class="text-muted small"></span>
            </div>

            <div class="list-group resource-list">
                @if (Model.Entries.Count == 0)
                {
                    <div class="list-group-item text-center text-muted py-4">å½“å‰ç›®å½•ä¸ºç©º</div>
                }
                else
                {
                    @foreach (var entry in Model.Entries)
                    {
                        <div class="list-group-item d-flex align-items-center gap-3 resource-item @(entry.IsDirectory ? "directory-item" : string.Empty)"
                             data-url="@(entry.IsDirectory ? Url.Page("/Resources/Index", new { tab = Model.SelectedTabString, path = entry.RelativePath, q = Model.Filter, sort = Model.SortFieldParam, dir = Model.SortDirectionParam }) : string.Empty)">
                            <div class="form-check">
                                @if (entry.IsDirectory)
                                {
                                    <input class="form-check-input entry-checkbox" type="checkbox" name="paths" value="@entry.RelativePath" data-kind="dir" />
                                }
                                else
                                {
                                    <input class="form-check-input entry-checkbox" type="checkbox" name="paths" value="@entry.RelativePath" data-kind="file" />
                                }
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="resource-icon">@((entry.IsDirectory ? "ğŸ“" : "ğŸ“„"))</span>
                                    <span class="fw-semibold text-primary">@entry.Name</span>
                                </div>
                                <div class="text-muted small">
                                    @if (entry.IsDirectory)
                                    {
                                        <span>ç›®å½•</span>
                                    }
                                    else
                                    {
                                        <span>@Model.FormatSize(entry.SizeBytes)</span>
                                    }
                                    <span class="ms-2">@entry.LastWriteTime.ToLocalTime().ToString("yyyy/MM/dd HH:mm")</span>
                                </div>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                @if (entry.IsDirectory)
                                {
                                    <a class="btn btn-outline-primary btn-sm"
                                       asp-page="/Resources/Index"
                                       asp-route-tab="@Model.SelectedTabString"
                                       asp-route-path="@entry.RelativePath"
                                       asp-route-q="@Model.Filter"
                                       asp-route-sort="@Model.SortFieldParam"
                                       asp-route-dir="@Model.SortDirectionParam">è¿›å…¥</a>
                                }
                                else
                                {
                                    <button type="button"
                                            class="btn btn-outline-secondary btn-sm preview-btn"
                                            data-preview-url="@Url.Page("/Resources/Index", "Preview", new { tab = Model.SelectedTabString, path = entry.RelativePath })"
                                            data-name="@entry.Name">é¢„è§ˆ</button>
                                    <a class="btn btn-outline-primary btn-sm download-link"
                                       data-download-url="@Url.Page("/Resources/Index", "Download", new { tab = Model.SelectedTabString, path = entry.RelativePath })">ä¸‹è½½</a>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        </form>
        }
        <form method="post" asp-page-handler="Delete" id="delete-form" class="d-none">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
            <input type="hidden" name="q" value="@Model.Filter" />
            <input type="hidden" name="sort" value="@Model.SortFieldParam" />
            <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
            <input type="hidden" name="view" value="@(Model.IsTrashView ? "trash" : string.Empty)" />
            <div id="delete-paths-container"></div>
        </form>
        <form method="post" asp-page-handler="Move" id="move-form" class="d-none">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
            <input type="hidden" name="q" value="@Model.Filter" />
            <input type="hidden" name="sort" value="@Model.SortFieldParam" />
            <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
            <input type="hidden" name="view" value="@(Model.IsTrashView ? "trash" : string.Empty)" />
            <input type="hidden" name="targetDir" id="move-target-dir" />
            <div id="move-paths-container"></div>
        </form>
        <form method="post" asp-page-handler="Rename" id="rename-form" class="d-none">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
            <input type="hidden" name="q" value="@Model.Filter" />
            <input type="hidden" name="sort" value="@Model.SortFieldParam" />
            <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
            <input type="hidden" name="view" value="@(Model.IsTrashView ? "trash" : string.Empty)" />
            <input type="hidden" name="renamePath" id="rename-path" />
            <input type="hidden" name="newName" id="rename-new-name" />
        </form>
        <form method="post" asp-page-handler="CreateShare" id="share-form" class="d-none">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <div id="share-targets-container"></div>
        </form>
        <form method="post" asp-page-handler="RestoreTrash" id="restore-form" class="d-none">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <input type="hidden" name="view" value="trash" />
            <div id="restore-paths-container"></div>
        </form>
        <form method="post" asp-page-handler="PurgeTrash" id="purge-form" class="d-none">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <input type="hidden" name="view" value="trash" />
            <div id="purge-paths-container"></div>
        </form>
    </section>
</div>

<div class="modal fade" id="preview-modal" tabindex="-1" aria-labelledby="preview-modal-title" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="preview-modal-title">æ–‡ä»¶é¢„è§ˆ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="preview-loading" class="text-muted">åŠ è½½ä¸­...</div>
                <div id="preview-message" class="alert alert-warning d-none"></div>
                <div id="preview-content" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="move-modal" tabindex="-1" aria-labelledby="move-modal-title" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="move-modal-title">ç§»åŠ¨åˆ°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="text-muted small" id="move-current-path">/</div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="move-up-btn">ä¸Šä¸€çº§</button>
                </div>
                <div id="move-message" class="alert alert-warning d-none"></div>
                <div id="move-list" class="list-group"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="move-confirm-btn" disabled>ç§»åŠ¨åˆ°æ­¤</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="share-modal" tabindex="-1" aria-labelledby="share-modal-title" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="share-modal-title">åˆ†äº«é“¾æ¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-muted small mb-2">è¯·æ‰‹åŠ¨å¤åˆ¶åˆ†äº«é“¾æ¥ï¼š</div>
                <input type="text" class="form-control" id="share-link-input" readonly />
                <div id="share-copy-status" class="small mt-2 text-muted invisible" style="min-height: 1.25rem;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" id="share-copy-btn">å¤åˆ¶é“¾æ¥</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function initResourcePage(root) {
            const container = root || document;
            const selectAll = container.querySelector('#select-all');
            const checkboxes = Array.from(container.querySelectorAll('.entry-checkbox'));
            const downloadBtn = container.querySelector('#download-zip-btn');
            const deleteBtn = container.querySelector('#delete-selected-btn');
            const moveBtn = container.querySelector('#move-selected-btn');
            const renameSelectedBtn = container.querySelector('#rename-selected-btn');
            const restoreBtn = container.querySelector('#restore-selected-btn');
            const purgeBtn = container.querySelector('#purge-selected-btn');
            const deleteForm = container.querySelector('#delete-form');
            const deletePathsContainer = container.querySelector('#delete-paths-container');
            const moveForm = container.querySelector('#move-form');
            const movePathsContainer = container.querySelector('#move-paths-container');
            const moveTargetDir = container.querySelector('#move-target-dir');
            const moveModalEl = document.getElementById('move-modal');
            const moveModal = window.bootstrap && moveModalEl ? new bootstrap.Modal(moveModalEl) : null;
            const moveList = document.getElementById('move-list');
            const moveMessage = document.getElementById('move-message');
            const moveCurrentPathEl = document.getElementById('move-current-path');
            const moveUpBtn = document.getElementById('move-up-btn');
            const moveConfirmBtn = document.getElementById('move-confirm-btn');
            const dirsEndpoint = document.getElementById('dirs-endpoint')?.value;
            let moveCurrentPath = '';
            let pendingMovePaths = [];
            const renameForm = container.querySelector('#rename-form');
            const renamePath = container.querySelector('#rename-path');
            const renameNewName = container.querySelector('#rename-new-name');
            const restoreForm = container.querySelector('#restore-form');
            const restorePathsContainer = container.querySelector('#restore-paths-container');
            const purgeForm = container.querySelector('#purge-form');
            const purgePathsContainer = container.querySelector('#purge-paths-container');
            const shareSelectedBtn = container.querySelector('#share-selected-btn');
            const shareForm = container.querySelector('#share-form');
            const shareTargetsContainer = container.querySelector('#share-targets-container');
            const uploadForm = container.querySelector('#upload-form');
            const uploadFile = container.querySelector('#upload-file');
            const uploadFolder = container.querySelector('#upload-folder');
            const uploadBtn = container.querySelector('#upload-submit');
            const uploadStatus = container.querySelector('#upload-status');
            const uploadProgressContainer = container.querySelector('#upload-progress-container');
            const uploadProgressBar = container.querySelector('#upload-progress-bar');
            const dropTarget = container.querySelector('.resource-list');
            const uploadDropTarget = container.querySelector('#upload-drop-target');
            const uploadCancelBtn = container.querySelector('#upload-cancel');
            const uploadSpeed = container.querySelector('#upload-speed');
            const sortForm = container.querySelector('#sort-form');
            const sortHidden = container.querySelector('#sort-hidden');
            const dirHidden = container.querySelector('#dir-hidden');
            const sortButtons = Array.from(container.querySelectorAll('.sort-btn'));
            const dirButtons = Array.from(container.querySelectorAll('.dir-btn'));
            const createFolderForm = container.querySelector('#create-folder-form');
            const createFolderBtn = container.querySelector('#create-folder-btn');
            const createFolderName = container.querySelector('#create-folder-name');
            const previewButtons = Array.from(container.querySelectorAll('.preview-btn'));
            const previewModalEl = document.getElementById('preview-modal');
            const previewTitle = document.getElementById('preview-modal-title');
            const previewContent = document.getElementById('preview-content');
            const previewMessage = document.getElementById('preview-message');
            const previewLoading = document.getElementById('preview-loading');
            const previewModal = window.bootstrap && previewModalEl ? new bootstrap.Modal(previewModalEl) : null;
            const shareModalEl = document.getElementById('share-modal');
            const shareModal = window.bootstrap && shareModalEl ? new bootstrap.Modal(shareModalEl) : null;
            const shareLinkInput = document.getElementById('share-link-input');
            const shareCopyBtn = document.getElementById('share-copy-btn');
            const shareCopyStatus = document.getElementById('share-copy-status');

            const updateState = () => {
                const selectedItems = checkboxes.filter(cb => cb.checked);
                const selected = selectedItems.length;
                if (downloadBtn) {
                    downloadBtn.textContent = `æ‰¹é‡ä¸‹è½½ ZIP (${selected})`;
                    downloadBtn.disabled = selected === 0;
                }
                if (deleteBtn) {
                    deleteBtn.disabled = selected === 0;
                }
                if (moveBtn) {
                    moveBtn.disabled = selected === 0;
                }
                if (renameSelectedBtn) {
                    renameSelectedBtn.disabled = selected !== 1;
                }
                if (restoreBtn) {
                    restoreBtn.disabled = selected === 0;
                }
                if (purgeBtn) {
                    purgeBtn.disabled = selected === 0;
                }
                if (shareSelectedBtn) {
                    shareSelectedBtn.disabled = selected === 0;
                }
                if (selectAll) {
                selectAll.indeterminate = selected > 0 && selected < checkboxes.length;
                selectAll.checked = selected > 0 && selected === checkboxes.length;
            }
        };

            checkboxes.forEach(cb => cb.addEventListener('change', updateState));
            if (selectAll) {
                selectAll.addEventListener('change', () => {
                    checkboxes.forEach(cb => {
                        cb.checked = selectAll.checked;
                    });
                    updateState();
                });
            }

            const showUploadStatus = (message, type) => {
                if (!uploadStatus) return;
                uploadStatus.classList.remove('d-none', 'alert-success', 'alert-danger');
                uploadStatus.classList.add(type === 'success' ? 'alert-success' : 'alert-danger');
                uploadStatus.textContent = message;
            };

            const collectUploadFiles = () => {
                const selected = [];
                if (uploadFile?.files?.length) {
                    selected.push(...Array.from(uploadFile.files));
                }
                if (uploadFolder?.files?.length) {
                    selected.push(...Array.from(uploadFolder.files));
                }
                return selected;
            };

            const getUploadFileName = (file) => {
                const relativePath = file?.webkitRelativePath;
                if (relativePath && relativePath.trim().length > 0) {
                    return relativePath;
                }
                return file.name;
            };

            const uploadState = {
                queue: [],
                inflight: new Set(),
                paused: false,
                cancelled: false,
                totalFiles: 0,
                completed: 0,
                success: 0,
                totalBytes: 0,
                uploadedBytes: 0,
                startAt: 0
            };

            const resetUploadUI = () => {
                if (uploadProgressContainer && uploadProgressBar) {
                    uploadProgressBar.style.width = '0%';
                    uploadProgressBar.textContent = '0%';
                    uploadProgressContainer.classList.add('d-none');
                }
                if (uploadSpeed) uploadSpeed.textContent = '';
                if (uploadBtn) uploadBtn.disabled = false;
                uploadCancelBtn?.classList.add('d-none');
                uploadCancelBtn?.setAttribute('disabled', 'disabled');
            };

            const resetUploadState = () => {
                uploadState.queue = [];
                uploadState.inflight.forEach((xhr) => xhr.abort());
                uploadState.inflight.clear();
                uploadState.paused = false;
                uploadState.cancelled = false;
                uploadState.totalFiles = 0;
                uploadState.completed = 0;
                uploadState.success = 0;
                uploadState.totalBytes = 0;
                uploadState.uploadedBytes = 0;
                uploadState.startAt = 0;
                resetUploadUI();
            };

            const updateUploadProgress = () => {
                if (uploadProgressContainer && uploadProgressBar) {
                    uploadProgressContainer.classList.remove('d-none');
                    let percent = 0;
                    if (uploadState.totalBytes > 0) {
                        percent = Math.floor((uploadState.uploadedBytes / uploadState.totalBytes) * 100);
                    } else if (uploadState.totalFiles > 0) {
                        percent = Math.floor((uploadState.completed / uploadState.totalFiles) * 100);
                    }
                    if (percent > 100) percent = 100;
                    uploadProgressBar.style.width = `${percent}%`;
                    const uploadedText = formatBytes(uploadState.uploadedBytes);
                    const totalText = formatBytes(uploadState.totalBytes);
                    uploadProgressBar.textContent = `${percent}% (${uploadedText} / ${totalText})`;
                }
                if (uploadSpeed) {
                    if (uploadState.startAt > 0 && uploadState.uploadedBytes > 0) {
                        const elapsed = (Date.now() - uploadState.startAt) / 1000;
                        const speed = uploadState.uploadedBytes / (elapsed || 1);
                        const units = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
                        let val = speed;
                        let idx = 0;
                        while (val >= 1024 && idx < units.length - 1) {
                            val /= 1024;
                            idx++;
                        }
                        uploadSpeed.textContent = `é€Ÿåº¦ï¼š${val.toFixed(val >= 10 ? 0 : 1)} ${units[idx]}`;
                    } else {
                        uploadSpeed.textContent = '';
                    }
                }
            };

            const startNextUpload = () => {
                if (uploadState.cancelled || uploadState.paused) return;
                const maxConcurrent = 3;
                if (uploadState.inflight.size >= maxConcurrent) return;
                const file = uploadState.queue.shift();
                if (!file) {
                    if (uploadState.inflight.size === 0) {
                        if (uploadState.success > 0) {
                            showUploadStatus(`ä¸Šä¼ å®Œæˆï¼šæˆåŠŸ ${uploadState.success}/${uploadState.totalFiles}ï¼Œæ­£åœ¨åˆ·æ–°åˆ—è¡¨...`, 'success');
                            window.location.reload();
                        } else {
                            showUploadStatus('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚', 'danger');
                            resetUploadUI();
                        }
                    }
                    return;
                }

                const xhr = new XMLHttpRequest();
                uploadState.inflight.add(xhr);
                xhr._lastLoaded = 0;
                xhr._expectedSize = file.size || 0;
                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const delta = event.loaded - (xhr._lastLoaded || 0);
                        xhr._lastLoaded = event.loaded;
                        uploadState.uploadedBytes += delta;
                        updateUploadProgress();
                    }
                };
                xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        uploadState.success++;
                    }
                };
                const finalize = () => {
                    uploadState.inflight.delete(xhr);
                    const remaining = Math.max(0, (xhr._expectedSize || 0) - (xhr._lastLoaded || 0));
                    uploadState.uploadedBytes += remaining;
                    if (uploadState.uploadedBytes > uploadState.totalBytes) {
                        uploadState.uploadedBytes = uploadState.totalBytes;
                    }
                    uploadState.completed++;
                    updateUploadProgress();
                    startNextUpload();
                };
                xhr.onerror = finalize;
                xhr.onabort = () => {
                    if (!uploadState.cancelled) {
                        uploadState.queue.unshift(file);
                    }
                    finalize();
                };
                xhr.onloadend = finalize;

                const formData = new FormData(uploadForm);
                formData.delete('files');
                formData.append('files', file, getUploadFileName(file));
                const token = uploadForm.querySelector('input[name=\"__RequestVerificationToken\"]')?.value;
                xhr.open('POST', uploadForm.action);
                if (token) xhr.setRequestHeader('RequestVerificationToken', token);
                xhr.send(formData);
                updateUploadProgress();

                startNextUpload();
            };

            const handleUploadSubmit = (files) => {
                if (!files || files.length === 0) {
                    showUploadStatus('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶ã€‚', 'danger');
                    return;
                }
                resetUploadState();
                uploadState.queue = Array.from(files);
                uploadState.totalFiles = uploadState.queue.length;
                uploadState.totalBytes = uploadState.queue.reduce((sum, f) => sum + (f.size || 0), 0);
                uploadState.startAt = Date.now();
                uploadBtn.disabled = true;
                uploadCancelBtn?.classList.remove('d-none');
                uploadCancelBtn?.removeAttribute('disabled');
                showUploadStatus(`å¼€å§‹ä¸Šä¼  ${uploadState.totalFiles} ä¸ªæ–‡ä»¶...`, 'success');
                updateUploadProgress();
                startNextUpload();
            };

            if (uploadForm && uploadBtn && (uploadFile || uploadFolder)) {
                uploadForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleUploadSubmit(collectUploadFiles());
                });
            }

            if (uploadFile) {
                uploadFile.addEventListener('change', () => {
                    if (uploadFolder) {
                        uploadFolder.value = '';
                    }
                    const selected = collectUploadFiles();
                    if (selected.length > 0) {
                        showUploadStatus(`å·²é€‰æ‹© ${selected.length} ä¸ªæ–‡ä»¶ï¼Œç‚¹å‡»ä¸Šä¼ å¼€å§‹ã€‚`, 'success');
                    }
                });
            }

            if (uploadFolder) {
                uploadFolder.addEventListener('change', () => {
                    if (uploadFile) {
                        uploadFile.value = '';
                    }
                    const selected = collectUploadFiles();
                    if (selected.length > 0) {
                        showUploadStatus(`å·²é€‰æ‹© ${selected.length} ä¸ªæ–‡ä»¶ï¼Œç‚¹å‡»ä¸Šä¼ å¼€å§‹ã€‚`, 'success');
                    }
                });
            }

            if (uploadCancelBtn) {
                uploadCancelBtn.addEventListener('click', () => {
                    uploadState.cancelled = true;
                    uploadCancelBtn.classList.add('d-none');
                    uploadCancelBtn.setAttribute('disabled', 'disabled');
                    uploadState.queue = [];
                    uploadState.inflight.forEach((xhr) => xhr.abort());
                    uploadState.uploadedBytes = 0;
                    resetUploadUI();
                    showUploadStatus('ä¸Šä¼ å·²åœæ­¢ã€‚', 'danger');
                });
            }

            const bindDropTarget = (target) => {
                if (!target || !uploadFile) return;
                let dragCounter = 0;
                const highlight = () => target.classList.add('drop-target-hover');
                const unhighlight = () => target.classList.remove('drop-target-hover');
                target.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    dragCounter++;
                    highlight();
                });
                target.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (e.dataTransfer) {
                        e.dataTransfer.dropEffect = 'copy';
                    }
                });
                target.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dragCounter = Math.max(0, dragCounter - 1);
                    if (dragCounter === 0) {
                        unhighlight();
                    }
                });
                target.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dragCounter = 0;
                    unhighlight();
                    const dt = e.dataTransfer;
                    if (!dt || !dt.files || dt.files.length === 0) return;
                    if (uploadFolder) {
                        uploadFolder.value = '';
                    }
                    uploadFile.files = dt.files;
                    showUploadStatus(`å·²é€‰æ‹© ${dt.files.length} ä¸ªæ–‡ä»¶ï¼Œç‚¹å‡»ä¸Šä¼ å¼€å§‹ã€‚`, 'success');
                });
            };

            if (uploadFile) {
                bindDropTarget(dropTarget);
                bindDropTarget(uploadDropTarget);
            }

            if (createFolderForm && createFolderBtn && createFolderName) {
                createFolderBtn.addEventListener('click', () => {
                    const name = prompt('è¯·è¾“å…¥æ–°æ–‡ä»¶å¤¹åç§°');
                    if (!name) return;
                    const trimmed = name.trim();
                    if (!trimmed) return;
                    createFolderName.value = trimmed;
                    createFolderForm.submit();
                });
            }

            const formatBytes = (size) => {
                if (size === undefined || size === null || Number.isNaN(Number(size))) return '';
                let value = Number(size);
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let unitIndex = 0;
                while (value >= 1024 && unitIndex < units.length - 1) {
                    value /= 1024;
                    unitIndex++;
                }
                return `${value.toFixed(value >= 10 ? 0 : 2)} ${units[unitIndex]}`;
            };

            const showPreviewMessage = (message) => {
                if (!previewMessage) return;
                previewMessage.textContent = message;
                previewMessage.classList.remove('d-none');
            };

            const resetPreview = (title) => {
                if (previewTitle && title) previewTitle.textContent = title;
                if (previewContent) previewContent.innerHTML = '';
                if (previewMessage) previewMessage.classList.add('d-none');
                if (previewLoading) previewLoading.classList.remove('d-none');
            };

            const openPreviewModal = () => {
                if (previewModal) {
                    previewModal.show();
                    return;
                }
                if (previewModalEl) {
                    previewModalEl.classList.add('show', 'd-block');
                }
            };

            const renderPreview = (data) => {
                if (!previewContent || !data) return;
                previewLoading?.classList.add('d-none');
                previewMessage?.classList.add('d-none');
                const kind = data.kind;
                if (!data.success) {
                    showPreviewMessage(data.message || 'é¢„è§ˆå¤±è´¥ã€‚');
                    return;
                }
                if (kind === 'text') {
                    const pre = document.createElement('pre');
                    pre.className = 'bg-light p-3 rounded border preview-text';
                    pre.textContent = data.content || '';
                    previewContent.appendChild(pre);
                    return;
                }
                if (kind === 'image') {
                    const img = document.createElement('img');
                    img.src = data.previewUrl;
                    img.alt = 'é¢„è§ˆå›¾ç‰‡';
                    img.className = 'img-fluid';
                    previewContent.appendChild(img);
                    return;
                }
                if (kind === 'audio') {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.className = 'w-100';
                    const source = document.createElement('source');
                    source.src = data.previewUrl;
                    audio.appendChild(source);
                    previewContent.appendChild(audio);
                    return;
                }
                if (kind === 'video') {
                    const video = document.createElement('video');
                    video.controls = true;
                    video.className = 'w-100';
                    video.style.maxHeight = '70vh';
                    const source = document.createElement('source');
                    source.src = data.previewUrl;
                    video.appendChild(source);
                    previewContent.appendChild(video);
                    return;
                }
                if (kind === 'pdf') {
                    const frame = document.createElement('iframe');
                    frame.src = data.previewUrl;
                    frame.className = 'w-100 border';
                    frame.style.minHeight = '480px';
                    previewContent.appendChild(frame);
                    return;
                }
                if (kind === 'zip') {
                    const info = document.createElement('div');
                    info.className = 'small text-muted mb-2';
                    info.textContent = data.truncated ? 'ä»…æ˜¾ç¤ºå‰ 200 æ¡ã€‚' : 'å…¨éƒ¨æ¡ç›®ã€‚';
                    previewContent.appendChild(info);
                    const list = document.createElement('ul');
                    list.className = 'list-group preview-zip-list';
                    (data.entries || []).forEach(e => {
                        const item = document.createElement('li');
                        item.className = 'list-group-item d-flex justify-content-between align-items-center';
                        const name = document.createElement('span');
                        name.textContent = e.name || '';
                        const size = document.createElement('span');
                        size.className = 'badge bg-secondary rounded-pill';
                        size.textContent = formatBytes(e.size);
                        item.appendChild(name);
                        item.appendChild(size);
                        list.appendChild(item);
                    });
                    previewContent.appendChild(list);
                    return;
                }

                showPreviewMessage('æš‚ä¸æ”¯æŒè¯¥æ–‡ä»¶ç±»å‹é¢„è§ˆã€‚');
            };

            const loadPreview = (url, name) => {
                if (!url) return;
                resetPreview(name || 'é¢„è§ˆ');
                openPreviewModal();
                fetch(url, { headers: { 'X-Requested-With': 'Fetch', 'Accept': 'application/json' } })
                    .then(res => res.ok ? res.json() : Promise.reject())
                    .then(data => renderPreview(data))
                    .catch(() => {
                        previewLoading?.classList.add('d-none');
                        showPreviewMessage('é¢„è§ˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
                    });
            };

            const renderMoveList = (data) => {
                if (!moveList || !moveConfirmBtn) return;
                moveList.innerHTML = '';
                moveConfirmBtn.disabled = false;
                if (!data?.success) {
                    moveMessage?.classList.remove('d-none');
                    if (moveMessage) moveMessage.textContent = data?.message || 'åŠ è½½ç›®å½•å¤±è´¥ã€‚';
                    moveConfirmBtn.disabled = true;
                    return;
                }
                moveMessage?.classList.add('d-none');
                if (moveCurrentPathEl) {
                    const displayPath = data.currentPath ? `/${data.currentPath}` : '/';
                    moveCurrentPathEl.textContent = displayPath;
                }
                const items = data.items || [];
                if (items.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'list-group-item text-muted';
                    empty.textContent = 'å½“å‰ç›®å½•ä¸‹æš‚æ— å­ç›®å½•';
                    moveList.appendChild(empty);
                } else {
                    items.forEach(item => {
                        const row = document.createElement('button');
                        row.type = 'button';
                        row.className = 'list-group-item list-group-item-action d-flex align-items-center gap-2';
                        row.innerHTML = `<span>ğŸ“</span><span class="fw-semibold">${item.name || ''}</span>`;
                        row.addEventListener('click', () => {
                            moveCurrentPath = item.path || '';
                            loadMoveList(moveCurrentPath);
                        });
                        moveList.appendChild(row);
                    });
                }
            };

            const loadMoveList = (path) => {
                if (!dirsEndpoint) return;
                moveConfirmBtn?.setAttribute('disabled', 'disabled');
                if (moveMessage) {
                    moveMessage.classList.add('d-none');
                    moveMessage.textContent = '';
                }
                moveList && (moveList.innerHTML = '<div class="list-group-item text-muted">åŠ è½½ä¸­...</div>');
                const url = new URL(dirsEndpoint, window.location.origin);
                url.searchParams.set('path', path || '');
                fetch(url, { headers: { 'X-Requested-With': 'Fetch', 'Accept': 'application/json' } })
                    .then(res => res.ok ? res.json() : Promise.reject())
                    .then(data => renderMoveList(data))
                    .catch(() => {
                        if (moveMessage) {
                            moveMessage.textContent = 'åŠ è½½ç›®å½•å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚';
                            moveMessage.classList.remove('d-none');
                        }
                        moveConfirmBtn?.setAttribute('disabled', 'disabled');
                    });
            };

            const openMoveModal = () => {
                if (moveModal) {
                    moveModal.show();
                } else if (moveModalEl) {
                    moveModalEl.classList.add('show', 'd-block');
                }
            };

            if (moveUpBtn) {
                moveUpBtn.addEventListener('click', () => {
                    if (!moveCurrentPath) {
                        loadMoveList('');
                        return;
                    }
                    const parts = moveCurrentPath.split('/').filter(Boolean);
                    parts.pop();
                    moveCurrentPath = parts.join('/');
                    loadMoveList(moveCurrentPath);
                });
            }

            if (moveConfirmBtn) {
                moveConfirmBtn.addEventListener('click', () => {
                    if (!moveForm || !movePathsContainer || !moveTargetDir) return;
                    movePathsContainer.innerHTML = '';
                    pendingMovePaths.forEach(val => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'paths';
                        input.value = val;
                        movePathsContainer.appendChild(input);
                    });
                    moveTargetDir.value = moveCurrentPath || '';
                    moveForm.submit();
                    if (moveModal) moveModal.hide();
                });
            }

            previewButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = btn.getAttribute('data-preview-url');
                    const name = btn.getAttribute('data-name') || 'é¢„è§ˆ';
                    loadPreview(url, name);
                });
            });

            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked);
                    if (selected.length === 0) {
                        alert('è¯·é€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ã€‚');
                        return;
                    }
                    // ç›´æ¥æäº¤å·²å‹¾é€‰çš„è·¯å¾„ï¼ŒåŒ…å«æ–‡ä»¶ä¸æ–‡ä»¶å¤¹
                    const form = container.querySelector('#zip-form');
                    if (!form) return;
                    form.submit();
                });
            }

            const downloadLinks = Array.from(container.querySelectorAll('.download-link'));
            downloadLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = link.getAttribute('data-download-url');
                    if (!url) return;
                    if (confirm('ç¡®å®šä¸‹è½½è¯¥æ–‡ä»¶ï¼Ÿ')) {
                        window.location.href = url;
                    }
                });
            });

            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
                    if (selected.length === 0) return;
                    if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selected.length} ä¸ªæ–‡ä»¶ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;
                    if (deleteForm && deletePathsContainer) {
                        deletePathsContainer.innerHTML = '';
                        selected.forEach(val => {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = 'paths';
                            input.value = val;
                            deletePathsContainer.appendChild(input);
                        });
                        deleteForm.submit();
                    }
                });
            }

            if (restoreBtn) {
                restoreBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
                    if (selected.length === 0 || !restoreForm || !restorePathsContainer) return;
                    restorePathsContainer.innerHTML = '';
                    selected.forEach(val => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'ids';
                        input.value = val;
                        restorePathsContainer.appendChild(input);
                    });
                    restoreForm.submit();
                });
            }

            if (purgeBtn) {
                purgeBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
                    if (selected.length === 0 || !purgeForm || !purgePathsContainer) return;
                    if (!confirm(`ç¡®å®šå½»åº•åˆ é™¤é€‰ä¸­çš„ ${selected.length} é¡¹ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) return;
                    purgePathsContainer.innerHTML = '';
                    selected.forEach(val => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'ids';
                        input.value = val;
                        purgePathsContainer.appendChild(input);
                    });
                    purgeForm.submit();
                });
            }

            if (moveBtn) {
                moveBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
                    if (selected.length === 0) return;
                    pendingMovePaths = selected;
                    moveCurrentPath = (container.querySelector('input[name="path"]')?.value ?? '').trim();
                    openMoveModal();
                    loadMoveList(moveCurrentPath);
                });
            }

            if (renameSelectedBtn) {
                renameSelectedBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
                    if (selected.length !== 1) return;
                    const path = selected[0];
                    const name = path.split('/').pop() || path;
                    if (!renameForm || !renamePath || !renameNewName) return;
                    const newName = prompt('è¯·è¾“å…¥æ–°åç§°ï¼ˆä¸å«è·¯å¾„åˆ†éš”ç¬¦ï¼‰ï¼š', name);
                    if (!newName) return;
                    const trimmed = newName.trim();
                    if (!trimmed) return;
                    renamePath.value = path;
                    renameNewName.value = trimmed;
                    renameForm.submit();
                });
            }

            const setShareStatus = (text, isError = false) => {
                if (!shareCopyStatus) return;
                shareCopyStatus.textContent = text;
                shareCopyStatus.classList.remove('invisible', 'text-danger', 'text-success');
                shareCopyStatus.classList.add(isError ? 'text-danger' : 'text-success');
            };

            const resetShareStatus = () => {
                if (!shareCopyStatus) return;
                shareCopyStatus.textContent = '';
                shareCopyStatus.classList.add('invisible');
                shareCopyStatus.classList.remove('text-danger', 'text-success');
            };

            const copyShareLink = async () => {
                const text = shareLinkInput?.value || '';
                if (!text) {
                    setShareStatus('æš‚æ— å¯å¤åˆ¶çš„é“¾æ¥ã€‚', true);
                    return;
                }
                if (navigator.clipboard && window.isSecureContext) {
                    try {
                        await navigator.clipboard.writeText(text);
                        setShareStatus('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
                        return;
                    } catch {
                        // fallthrough toæ‰‹åŠ¨
                    }
                }
                if (shareLinkInput) {
                    shareLinkInput.focus();
                    shareLinkInput.select();
                }
                const ok = document.execCommand && document.execCommand('copy');
                if (ok) {
                    setShareStatus('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
                } else {
                    setShareStatus('æœªèƒ½è‡ªåŠ¨å¤åˆ¶ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚', true);
                }
            };

            if (shareCopyBtn) {
                shareCopyBtn.addEventListener('click', () => {
                    copyShareLink();
                });
            }

            if (shareSelectedBtn) {
                shareSelectedBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
                    if (selected.length === 0 || !shareForm || !shareTargetsContainer) return;
                    shareTargetsContainer.innerHTML = '';
                    selected.forEach(val => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'targets';
                        input.value = val;
                        shareTargetsContainer.appendChild(input);
                    });
                    const formData = new FormData(shareForm);
                    const token = shareForm.querySelector('input[name="__RequestVerificationToken"]')?.value;
                    const headers = token ? { 'RequestVerificationToken': token } : {};
                    fetch(shareForm.action, {
                        method: 'POST',
                        body: formData,
                        headers
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (!data.success || !data.url) {
                                alert(data.message || 'åˆ†äº«é“¾æ¥ç”Ÿæˆå¤±è´¥ã€‚');
                                return;
                            }
                            resetShareStatus();
                            if (shareLinkInput) {
                                shareLinkInput.value = data.url;
                            }
                            if (shareModal) {
                                shareModal.show();
                            } else {
                                alert(`åˆ†äº«é“¾æ¥ï¼š${data.url}`);
                            }
                        })
                        .catch(() => alert('åˆ†äº«é“¾æ¥ç”Ÿæˆå¤±è´¥ã€‚'));
                });
            }


            const tabLinks = Array.from(container.querySelectorAll('.resource-tab-link'));
            const contentRoot = document.getElementById('resource-page-content');
            const directoryItems = Array.from(container.querySelectorAll('.directory-item[data-url]'));
            const backLinks = Array.from(container.querySelectorAll('.back-link'));
            const loadPage = (url, push) => {
                if (!contentRoot) return;
                fetch(url, { headers: { 'X-Requested-With': 'Fetch' } })
                    .then(res => res.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newContent = doc.getElementById('resource-page-content');
                        if (newContent) {
                            contentRoot.innerHTML = newContent.innerHTML;
                            if (push) history.pushState({}, '', url);
                            initResourcePage(contentRoot);
                        }
                    })
                    .catch(err => console.warn('å±€éƒ¨åŠ è½½å¤±è´¥ï¼š', err));
            };

            const navigateWithSort = () => {
                if (!sortForm) return;
                const targetUrl = sortForm.action ? new URL(sortForm.action, window.location.origin) : new URL(window.location.href);
                const formData = new FormData(sortForm);
                targetUrl.search = new URLSearchParams(formData).toString();
                loadPage(targetUrl.toString(), true);
            };

            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = link.getAttribute('href');
                    if (!url) return;
                    loadPage(url, true);
                });
            });

            directoryItems.forEach(item => {
                item.addEventListener('dblclick', () => {
                    const url = item.getAttribute('data-url');
                    if (!url) return;
                    loadPage(url, true);
                });
            });

            backLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = link.getAttribute('href');
                    if (!url) return;
                    loadPage(url, true);
                });
            });

            window.onpopstate = () => loadPage(location.href, false);

            sortButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    sortButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    if (sortHidden) sortHidden.value = btn.dataset.sort;
                    navigateWithSort();
                });
            });

            dirButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    dirButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    if (dirHidden) dirHidden.value = btn.dataset.dir;
                    navigateWithSort();
                });
            });

            if (sortForm) {
                sortForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    // ensure hidden values are aligned; active classes already set
                    const activeSort = sortButtons.find(b => b.classList.contains('active'));
                    const activeDir = dirButtons.find(b => b.classList.contains('active'));
                    if (activeSort && sortHidden) sortHidden.value = activeSort.dataset.sort;
                    if (activeDir && dirHidden) dirHidden.value = activeDir.dataset.dir;
                    navigateWithSort();
                });
            }
            updateState();
        }

        window.addEventListener('DOMContentLoaded', () => initResourcePage(document));
    </script>
}
