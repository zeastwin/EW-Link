@page "/resources"
@model EW_Link.Pages.Resources.IndexModel
@using EW_Link.Services
@{
    ViewData["Title"] = "ËµÑÊ∫êÈó®Êà∑";
    string ActiveTab(ResourceTab tab) => Model.SelectedTab == tab ? "active" : string.Empty;
    var currentPathDisplay = string.IsNullOrWhiteSpace(Model.CurrentPath) ? "/" : Model.CurrentPath;
}

<div id="resource-page-content" class="resource-shell">
    <section class="glass-panel shadow-sm">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
            <div class="d-flex align-items-center gap-2">
                <a class="badge rounded-pill resource-tab-link tab-chip tab-chip-strong @ActiveTab(ResourceTab.Permanent)"
                   asp-page="/Resources/Index"
                   asp-route-tab="permanent"
                   asp-route-path="@Model.CurrentPath"
                   asp-route-q="@Model.Filter"
                   asp-route-sort="@Model.SortFieldParam"
                   asp-route-dir="@Model.SortDirectionParam">Ê∞∏‰πÖÊñá‰ª∂Â§π</a>
                <a class="badge rounded-pill resource-tab-link tab-chip tab-chip-strong @ActiveTab(ResourceTab.Temporary)"
                   asp-page="/Resources/Index"
                   asp-route-tab="temporary"
                   asp-route-path="@Model.CurrentPath"
                   asp-route-q="@Model.Filter"
                   asp-route-sort="@Model.SortFieldParam"
                   asp-route-dir="@Model.SortDirectionParam">‰∏¥Êó∂Êñá‰ª∂Â§π</a>
            </div>
            <div class="text-end small text-muted">
                <span class="me-3">ÁõÆÂΩïÊï∞Ôºö@Model.DirectoryCount</span>
                <span class="me-3">Êñá‰ª∂Êï∞Ôºö@Model.FileCount</span>
                <span>ÊÄªÂ§ßÂ∞èÔºö@Model.FormatSize(Model.TotalSize)</span>
            </div>
        </div>

        @if (TempData["SuccessMessage"] is string successMessage)
        {
            <div class="alert alert-success" role="alert">
                @successMessage
            </div>
        }
        @if (TempData["ErrorMessage"] is string errorMessage)
        {
            <div class="alert alert-danger" role="alert">
                @errorMessage
            </div>
        }
        @if (!ViewData.ModelState.IsValid)
        {
            <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>
        }

        <div class="d-flex flex-wrap align-items-center gap-2 mb-3 breadcrumb-bar">
            <div class="text-muted small">Ë∑ØÂæÑÔºö@currentPathDisplay</div>
        </div>

        <div class="action-panel row g-3 mb-3 align-items-center">
            <div class="col-12 col-lg-7 d-flex flex-wrap align-items-center gap-2">
                <form id="upload-form" method="post" enctype="multipart/form-data" asp-page-handler="Upload" class="d-flex flex-wrap align-items-center gap-2 flex-grow-1">
                    <input type="hidden" name="tab" value="@Model.SelectedTabString" />
                    <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
                    <input type="hidden" name="q" value="@Model.Filter" />
                    <input type="hidden" name="sort" value="@Model.SortFieldParam" />
                    <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
                    <input type="file" name="file" id="upload-file" class="form-control flex-grow-1" />
                    <button type="submit" class="btn btn-success px-3" id="upload-submit">‰∏ä‰º†</button>
                </form>
            </div>
            <div class="col-12 col-lg-5">
                <form id="sort-form" method="get" class="d-flex flex-wrap align-items-center gap-2 justify-content-lg-end">
                    <input type="hidden" name="tab" value="@Model.SelectedTabString" />
                    <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
                    <input type="hidden" id="sort-hidden" name="sort" value="@Model.SortFieldParam" />
                    <input type="hidden" id="dir-hidden" name="dir" value="@Model.SortDirectionParam" />
                    <input class="form-control search-compact" type="search" name="q" placeholder="Êñá‰ª∂ÂêçËøáÊª§" value="@Model.Filter" />
                    <div class="btn-group compact-group" role="group" aria-label="Sort">
                        <button type="button" data-sort="name" class="btn btn-outline-primary sort-btn @(Model.SortFieldParam=="name"?"active":"")">ÂêçÁß∞</button>
                        <button type="button" data-sort="time" class="btn btn-outline-primary sort-btn @(Model.SortFieldParam=="time"?"active":"")">Êó∂Èó¥</button>
                        <button type="button" data-sort="size" class="btn btn-outline-primary sort-btn @(Model.SortFieldParam=="size"?"active":"")">Â§ßÂ∞è</button>
                    </div>
                    <div class="btn-group compact-group" role="group" aria-label="Dir">
                        <button type="button" data-dir="asc" class="btn btn-outline-secondary dir-btn @(Model.SortDirectionParam=="asc"?"active":"")">Âçá</button>
                        <button type="button" data-dir="desc" class="btn btn-outline-secondary dir-btn @(Model.SortDirectionParam=="desc"?"active":"")">Èôç</button>
                    </div>
                </form>
            </div>
        </div>

        <form method="post" asp-page-handler="DownloadZip" id="zip-form" class="resource-list-form">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
            <input type="hidden" name="q" value="@Model.Filter" />
            <input type="hidden" name="sort" value="@Model.SortFieldParam" />
            <input type="hidden" name="dir" value="@Model.SortDirectionParam" />

            <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                <a class="btn btn-return btn-sm back-link"
                   href="@Url.Page("/Resources/Index", new { tab = Model.SelectedTabString, path = Model.ParentPath, q = Model.Filter, sort = Model.SortFieldParam, dir = Model.SortDirectionParam })">‚¨Ö ËøîÂõû‰∏ä‰∏ÄÁ∫ß</a>
                <button type="button" class="btn btn-primary" id="download-zip-btn" disabled>ÊâπÈáè‰∏ãËΩΩ ZIP (0)</button>
                <button type="button" class="btn btn-outline-danger" id="delete-selected-btn" disabled>Âà†Èô§ÊâÄÈÄâ</button>
                <div class="text-muted">Â∑≤ÈÄâ <span id="selected-count" class="fw-bold">0</span> È°π</div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="select-all" />
                    <label class="form-check-label" for="select-all">ÂÖ®ÈÄâÂàóË°®</label>
                </div>
            </div>

            <div id="upload-status" class="alert d-none" role="alert"></div>
            <div id="upload-progress-container" class="progress mb-3 d-none">
                <div id="upload-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>

            <div class="list-group resource-list">
                @if (Model.Entries.Count == 0)
                {
                    <div class="list-group-item text-center text-muted py-4">ÂΩìÂâçÁõÆÂΩï‰∏∫Á©∫</div>
                }
                else
                {
                    @foreach (var entry in Model.Entries)
                    {
                        <div class="list-group-item d-flex align-items-center gap-3 resource-item @(entry.IsDirectory ? "directory-item" : string.Empty)"
                             data-url="@(entry.IsDirectory ? Url.Page("/Resources/Index", new { tab = Model.SelectedTabString, path = entry.RelativePath, q = Model.Filter, sort = Model.SortFieldParam, dir = Model.SortDirectionParam }) : string.Empty)">
                            <div class="form-check">
                                @if (entry.IsDirectory)
                                {
                                    <input class="form-check-input" type="checkbox" disabled />
                                }
                                else
                                {
                                    <input class="form-check-input entry-checkbox" type="checkbox" name="paths" value="@entry.RelativePath" />
                                }
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="resource-icon">@((entry.IsDirectory ? "üìÅ" : "üìÑ"))</span>
                                    <span class="fw-semibold text-primary">@entry.Name</span>
                                </div>
                                <div class="text-muted small">
                                    @if (entry.IsDirectory)
                                    {
                                        <span>ÁõÆÂΩï</span>
                                    }
                                    else
                                    {
                                        <span>@Model.FormatSize(entry.SizeBytes)</span>
                                    }
                                    <span class="ms-2">@entry.LastWriteTime.ToLocalTime().ToString("yyyy/MM/dd HH:mm")</span>
                                </div>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                @if (entry.IsDirectory)
                                {
                                    <a class="btn btn-outline-primary btn-sm"
                                       asp-page="/Resources/Index"
                                       asp-route-tab="@Model.SelectedTabString"
                                       asp-route-path="@entry.RelativePath"
                                       asp-route-q="@Model.Filter"
                                       asp-route-sort="@Model.SortFieldParam"
                                       asp-route-dir="@Model.SortDirectionParam">ËøõÂÖ•</a>
                                }
                                else
                                {
                                    <a class="btn btn-outline-primary btn-sm download-link"
                                       data-download-url="@Url.Page("/Resources/Index", "Download", new { tab = Model.SelectedTabString, path = entry.RelativePath })">‰∏ãËΩΩ</a>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        </form>
        <form method="post" asp-page-handler="Delete" id="delete-form" class="d-none">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
            <input type="hidden" name="q" value="@Model.Filter" />
            <input type="hidden" name="sort" value="@Model.SortFieldParam" />
            <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
            <div id="delete-paths-container"></div>
        </form>
    </section>
</div>

@section Scripts {
    <script>
        function initResourcePage(root) {
            const container = root || document;
            const selectAll = container.querySelector('#select-all');
            const checkboxes = Array.from(container.querySelectorAll('.entry-checkbox'));
            const selectedCount = container.querySelector('#selected-count');
            const downloadBtn = container.querySelector('#download-zip-btn');
            const deleteBtn = container.querySelector('#delete-selected-btn');
            const deleteForm = container.querySelector('#delete-form');
            const deletePathsContainer = container.querySelector('#delete-paths-container');
            const uploadForm = container.querySelector('#upload-form');
            const uploadFile = container.querySelector('#upload-file');
            const uploadBtn = container.querySelector('#upload-submit');
            const uploadStatus = container.querySelector('#upload-status');
            const uploadProgressContainer = container.querySelector('#upload-progress-container');
            const uploadProgressBar = container.querySelector('#upload-progress-bar');
            const sortForm = container.querySelector('#sort-form');
            const sortHidden = container.querySelector('#sort-hidden');
            const dirHidden = container.querySelector('#dir-hidden');
            const sortButtons = Array.from(container.querySelectorAll('.sort-btn'));
            const dirButtons = Array.from(container.querySelectorAll('.dir-btn'));

            const updateState = () => {
                const selected = checkboxes.filter(cb => cb.checked).length;
                if (selectedCount) selectedCount.textContent = selected.toString();
                if (downloadBtn) {
                    downloadBtn.textContent = `ÊâπÈáè‰∏ãËΩΩ ZIP (${selected})`;
                    downloadBtn.disabled = selected === 0;
                }
                if (deleteBtn) {
                    deleteBtn.disabled = selected === 0;
                }
                if (selectAll) {
                    selectAll.indeterminate = selected > 0 && selected < checkboxes.length;
                    selectAll.checked = selected > 0 && selected === checkboxes.length;
                }
            };

            checkboxes.forEach(cb => cb.addEventListener('change', updateState));
            if (selectAll) {
                selectAll.addEventListener('change', () => {
                    checkboxes.forEach(cb => {
                        cb.checked = selectAll.checked;
                    });
                    updateState();
                });
            }

            const showUploadStatus = (message, type) => {
                if (!uploadStatus) return;
                uploadStatus.classList.remove('d-none', 'alert-success', 'alert-danger');
                uploadStatus.classList.add(type === 'success' ? 'alert-success' : 'alert-danger');
                uploadStatus.textContent = message;
            };

            if (uploadForm && uploadFile && uploadBtn) {
                uploadForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (!uploadFile.files || uploadFile.files.length === 0) {
                        showUploadStatus('ËØ∑ÈÄâÊã©Ë¶Å‰∏ä‰º†ÁöÑÊñá‰ª∂„ÄÇ', 'danger');
                        return;
                    }
                    const formData = new FormData(uploadForm);
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', uploadForm.action);
                    const token = uploadForm.querySelector('input[name="__RequestVerificationToken"]')?.value;
                    if (token) xhr.setRequestHeader('RequestVerificationToken', token);
                    uploadBtn.disabled = true;
                    if (uploadProgressContainer && uploadProgressBar) {
                        uploadProgressContainer.classList.remove('d-none');
                        uploadProgressBar.style.width = '0%';
                        uploadProgressBar.textContent = '0%';
                    }
                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable && uploadProgressBar) {
                            const percent = Math.floor((event.loaded / event.total) * 100);
                            uploadProgressBar.style.width = `${percent}%`;
                            uploadProgressBar.textContent = `${percent}%`;
                        }
                    };
                    xhr.onerror = () => {
                        showUploadStatus('‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ', 'danger');
                        uploadBtn.disabled = false;
                    };
                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            showUploadStatus('‰∏ä‰º†ÊàêÂäüÔºåÊ≠£Âú®Âà∑Êñ∞ÂàóË°®...', 'success');
                            window.location.reload();
                        } else {
                            showUploadStatus('‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂ÊàñÈáçËØï„ÄÇ', 'danger');
                            uploadBtn.disabled = false;
                        }
                    };
                    xhr.send(formData);
                });
            }

            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
                    if (selected.length === 0) return;
                    if (!confirm(`Á°ÆÂÆöÊâπÈáè‰∏ãËΩΩÈÄâ‰∏≠ÁöÑ ${selected.length} ‰∏™Êñá‰ª∂Ôºü`)) return;
                    const form = container.querySelector('#zip-form');
                    form?.submit();
                });
            }

            const downloadLinks = Array.from(container.querySelectorAll('.download-link'));
            downloadLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = link.getAttribute('data-download-url');
                    if (!url) return;
                    if (confirm('Á°ÆÂÆö‰∏ãËΩΩËØ•Êñá‰ª∂Ôºü')) {
                        window.location.href = url;
                    }
                });
            });

            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
                    if (selected.length === 0) return;
                    if (!confirm(`Á°ÆÂÆöÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selected.length} ‰∏™Êñá‰ª∂ÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`)) return;
                    if (deleteForm && deletePathsContainer) {
                        deletePathsContainer.innerHTML = '';
                        selected.forEach(val => {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = 'paths';
                            input.value = val;
                            deletePathsContainer.appendChild(input);
                        });
                        deleteForm.submit();
                    }
                });
            }

            const tabLinks = Array.from(container.querySelectorAll('.resource-tab-link'));
            const contentRoot = document.getElementById('resource-page-content');
            const directoryItems = Array.from(container.querySelectorAll('.directory-item[data-url]'));
            const backLinks = Array.from(container.querySelectorAll('.back-link'));
            const loadPage = (url, push) => {
                if (!contentRoot) return;
                fetch(url, { headers: { 'X-Requested-With': 'Fetch' } })
                    .then(res => res.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newContent = doc.getElementById('resource-page-content');
                        if (newContent) {
                            contentRoot.innerHTML = newContent.innerHTML;
                            if (push) history.pushState({}, '', url);
                            initResourcePage(contentRoot);
                        }
                    })
                    .catch(err => console.warn('Â±ÄÈÉ®Âä†ËΩΩÂ§±Ë¥•Ôºö', err));
            };

            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = link.getAttribute('href');
                    if (!url) return;
                    loadPage(url, true);
                });
            });

            directoryItems.forEach(item => {
                item.addEventListener('dblclick', () => {
                    const url = item.getAttribute('data-url');
                    if (!url) return;
                    loadPage(url, true);
                });
            });

            backLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = link.getAttribute('href');
                    if (!url) return;
                    loadPage(url, true);
                });
            });

            window.onpopstate = () => loadPage(location.href, false);

            sortButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    sortButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    if (sortHidden) sortHidden.value = btn.dataset.sort;
                    if (sortForm) sortForm.submit();
                });
            });

            dirButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    dirButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    if (dirHidden) dirHidden.value = btn.dataset.dir;
                    if (sortForm) sortForm.submit();
                });
            });

            if (sortForm) {
                sortForm.addEventListener('submit', (e) => {
                    // ensure hidden values are aligned; active classes already set
                    const activeSort = sortButtons.find(b => b.classList.contains('active'));
                    const activeDir = dirButtons.find(b => b.classList.contains('active'));
                    if (activeSort && sortHidden) sortHidden.value = activeSort.dataset.sort;
                    if (activeDir && dirHidden) dirHidden.value = activeDir.dataset.dir;
                });
            }
            updateState();
        }

        window.addEventListener('DOMContentLoaded', () => initResourcePage(document));
    </script>
}
