@page "/resources"
@model EW_Link.Pages.Resources.IndexModel
@using EW_Link.Services
@{
    ViewData["Title"] = "ËµÑÊ∫êÈó®Êà∑";
    string ActiveTab(ResourceTab tab) => Model.SelectedTab == tab ? "active" : string.Empty;
    var currentPathDisplay = string.IsNullOrWhiteSpace(Model.CurrentPath) ? "/" : Model.CurrentPath;
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h3 mb-1">ËµÑÊ∫êÈó®Êà∑</h1>
            <p class="text-muted mb-0">ÊµèËßà„ÄÅ‰∏ä‰º†„ÄÅ‰∏ãËΩΩËµÑÊ∫êÊñá‰ª∂</p>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link @ActiveTab(ResourceTab.Permanent)"
               asp-page="/Resources/Index"
               asp-route-tab="permanent"
               asp-route-path="@Model.CurrentPath"
               asp-route-q="@Model.Filter"
               asp-route-sort="@Model.SortFieldParam"
               asp-route-dir="@Model.SortDirectionParam">Ê∞∏‰πÖÊñá‰ª∂Â§π</a>
        </li>
        <li class="nav-item">
            <a class="nav-link @ActiveTab(ResourceTab.Temporary)"
               asp-page="/Resources/Index"
               asp-route-tab="temporary"
               asp-route-path="@Model.CurrentPath"
               asp-route-q="@Model.Filter"
               asp-route-sort="@Model.SortFieldParam"
               asp-route-dir="@Model.SortDirectionParam">‰∏¥Êó∂Êñá‰ª∂Â§π</a>
        </li>
    </ul>

    @if (TempData["SuccessMessage"] is string successMessage)
    {
        <div class="alert alert-success" role="alert">
            @successMessage
        </div>
    }
    @if (TempData["ErrorMessage"] is string errorMessage)
    {
        <div class="alert alert-danger" role="alert">
            @errorMessage
        </div>
    }
    @if (!ViewData.ModelState.IsValid)
    {
        <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>
    }

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
                <div>
                    <div class="fw-semibold text-secondary">ÂΩìÂâç‰ΩçÁΩÆÔºö@Model.Breadcrumbs.Last().Name</div>
                    <div class="text-muted small">Ë∑ØÂæÑÔºö@currentPathDisplay</div>
                </div>
                <div class="text-end text-muted small">
                    <span class="me-3">ÁõÆÂΩïÊï∞Ôºö@Model.DirectoryCount</span>
                    <span class="me-3">Êñá‰ª∂Êï∞Ôºö@Model.FileCount</span>
                    <span>ÊÄªÂ§ßÂ∞èÔºö@Model.FormatSize(Model.TotalSize)</span>
                </div>
            </div>

            <div class="resource-toolbar row g-2 align-items-center mb-3">
                <div class="col-12 col-lg-6 d-flex flex-wrap align-items-center gap-2">
                    <form id="upload-form" method="post" enctype="multipart/form-data" asp-page-handler="Upload" class="d-flex flex-wrap align-items-center gap-2">
                        <input type="hidden" name="tab" value="@Model.SelectedTabString" />
                        <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
                        <input type="hidden" name="q" value="@Model.Filter" />
                        <input type="hidden" name="sort" value="@Model.SortFieldParam" />
                        <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
                        <input type="file" name="file" id="upload-file" class="form-control" />
                        <button type="submit" class="btn btn-success" id="upload-submit">‰∏ä‰º†Êñá‰ª∂</button>
                    </form>
                    <a class="btn btn-outline-secondary @(!string.IsNullOrWhiteSpace(Model.ParentPath) ? string.Empty : "disabled")"
                       asp-page="/Resources/Index"
                       asp-route-tab="@Model.SelectedTabString"
                       asp-route-path="@Model.ParentPath"
                       asp-route-q="@Model.Filter"
                       asp-route-sort="@Model.SortFieldParam"
                       asp-route-dir="@Model.SortDirectionParam">ËøîÂõû‰∏ä‰∏ÄÁ∫ß</a>
                </div>

                <div class="col-12 col-lg-6 d-flex flex-wrap align-items-center gap-2 justify-content-lg-end">
                    <form method="get" class="d-flex flex-wrap align-items-center gap-2">
                        <input type="hidden" name="tab" value="@Model.SelectedTabString" />
                        <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
                        <input class="form-control flex-grow-1 min-w-0" type="search" name="q" placeholder="Êñá‰ª∂ÂêçËøáÊª§" value="@Model.Filter" />
                        <select class="form-select" name="sort">
                            <option value="name" selected="@(Model.SortFieldParam == "name")">ÊåâÂêçÁß∞</option>
                            <option value="time" selected="@(Model.SortFieldParam == "time")">ÊåâÊó∂Èó¥</option>
                            <option value="size" selected="@(Model.SortFieldParam == "size")">ÊåâÂ§ßÂ∞è</option>
                        </select>
                        <select class="form-select" name="dir">
                            <option value="asc" selected="@(Model.SortDirectionParam == "asc")">ÂçáÂ∫è</option>
                            <option value="desc" selected="@(Model.SortDirectionParam == "desc")">ÈôçÂ∫è</option>
                        </select>
                        <button type="submit" class="btn btn-outline-primary">ÊêúÁ¥¢</button>
                    </form>
                </div>
            </div>

            <form method="post" asp-page-handler="DownloadZip" id="zip-form" class="resource-list-form">
                <input type="hidden" name="tab" value="@Model.SelectedTabString" />
                <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
                <input type="hidden" name="q" value="@Model.Filter" />
                <input type="hidden" name="sort" value="@Model.SortFieldParam" />
                <input type="hidden" name="dir" value="@Model.SortDirectionParam" />

                <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                    <button type="button" class="btn btn-primary" id="download-zip-btn" disabled>ÊâπÈáè‰∏ãËΩΩ ZIP (0)</button>
                    <button type="button" class="btn btn-outline-danger" id="delete-selected-btn" disabled>Âà†Èô§ÊâÄÈÄâ</button>
                    <div class="text-muted">Â∑≤ÈÄâ <span id="selected-count" class="fw-bold">0</span> È°π</div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="select-all" />
                        <label class="form-check-label" for="select-all">ÂÖ®ÈÄâÂàóË°®</label>
                    </div>
                    <a class="btn btn-outline-secondary @(!string.IsNullOrWhiteSpace(Model.ParentPath) ? string.Empty : "disabled")"
                       asp-page="/Resources/Index"
                       asp-route-tab="@Model.SelectedTabString"
                       asp-route-path="@Model.ParentPath"
                       asp-route-q="@Model.Filter"
                       asp-route-sort="@Model.SortFieldParam"
                       asp-route-dir="@Model.SortDirectionParam">ËøîÂõû‰∏ä‰∏ÄÁ∫ß</a>
                </div>

                <div id="upload-status" class="alert d-none" role="alert"></div>
                <div id="upload-progress-container" class="progress mb-3 d-none">
                    <div id="upload-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>

                <div class="list-group resource-list">
                    @if (Model.Entries.Count == 0)
                    {
                        <div class="list-group-item text-center text-muted py-4">ÂΩìÂâçÁõÆÂΩï‰∏∫Á©∫</div>
                    }
                    else
                    {
                        @foreach (var entry in Model.Entries)
                        {
                            <div class="list-group-item d-flex align-items-center gap-3 resource-item">
                                <div class="form-check">
                                    @if (entry.IsDirectory)
                                    {
                                        <input class="form-check-input" type="checkbox" disabled />
                                    }
                                    else
                                    {
                                        <input class="form-check-input entry-checkbox" type="checkbox" name="paths" value="@entry.RelativePath" />
                                    }
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="resource-icon">@((entry.IsDirectory ? "üìÅ" : "üìÑ"))</span>
                                        <span class="fw-semibold text-primary">@entry.Name</span>
                                    </div>
                                    <div class="text-muted small">
                                        @if (entry.IsDirectory)
                                        {
                                            <span>ÁõÆÂΩï</span>
                                        }
                                        else
                                        {
                                            <span>@Model.FormatSize(entry.SizeBytes)</span>
                                        }
                                        <span class="ms-2">@entry.LastWriteTime.ToLocalTime().ToString("yyyy/MM/dd HH:mm")</span>
                                    </div>
                                </div>
                                <div class="d-flex flex-wrap gap-2">
                                    @if (entry.IsDirectory)
                                    {
                                        <a class="btn btn-outline-primary btn-sm"
                                           asp-page="/Resources/Index"
                                           asp-route-tab="@Model.SelectedTabString"
                                           asp-route-path="@entry.RelativePath"
                                           asp-route-q="@Model.Filter"
                                           asp-route-sort="@Model.SortFieldParam"
                                           asp-route-dir="@Model.SortDirectionParam">ËøõÂÖ•</a>
                                    }
                                    else
                                    {
                                        <a class="btn btn-outline-primary btn-sm download-link"
                                           data-download-url="@Url.Page("/Resources/Index", "Download", new { tab = Model.SelectedTabString, path = entry.RelativePath })">‰∏ãËΩΩ</a>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            </form>
            <form method="post" asp-page-handler="Delete" id="delete-form" class="d-none">
                <input type="hidden" name="tab" value="@Model.SelectedTabString" />
                <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
                <input type="hidden" name="q" value="@Model.Filter" />
                <input type="hidden" name="sort" value="@Model.SortFieldParam" />
                <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
                <div id="delete-paths-container"></div>
            </form>
        </div>
    </div>

@section Scripts {
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const selectAll = document.getElementById('select-all');
            const checkboxes = Array.from(document.querySelectorAll('.entry-checkbox'));
            const selectedCount = document.getElementById('selected-count');
            const downloadBtn = document.getElementById('download-zip-btn');
            const deleteBtn = document.getElementById('delete-selected-btn');
            const deleteForm = document.getElementById('delete-form');
            const deletePathsContainer = document.getElementById('delete-paths-container');
            const uploadForm = document.getElementById('upload-form');
            const uploadFile = document.getElementById('upload-file');
            const uploadBtn = document.getElementById('upload-submit');
            const uploadStatus = document.getElementById('upload-status');
            const uploadProgressContainer = document.getElementById('upload-progress-container');
            const uploadProgressBar = document.getElementById('upload-progress-bar');

            const updateState = () => {
                const selected = checkboxes.filter(cb => cb.checked).length;
                selectedCount.textContent = selected.toString();
                if (downloadBtn) {
                    downloadBtn.textContent = `ÊâπÈáè‰∏ãËΩΩ ZIP (${selected})`;
                    downloadBtn.disabled = selected === 0;
                }
                if (deleteBtn) {
                    deleteBtn.disabled = selected === 0;
                }
                if (selectAll) {
                    selectAll.indeterminate = selected > 0 && selected < checkboxes.length;
                    selectAll.checked = selected > 0 && selected === checkboxes.length;
                }
            };

            checkboxes.forEach(cb => cb.addEventListener('change', updateState));

            if (selectAll) {
                selectAll.addEventListener('change', () => {
                    checkboxes.forEach(cb => {
                        cb.checked = selectAll.checked;
                    });
                    updateState();
                });
            }

            const showUploadStatus = (message, type) => {
                if (!uploadStatus) return;
                uploadStatus.classList.remove('d-none', 'alert-success', 'alert-danger');
                uploadStatus.classList.add(type === 'success' ? 'alert-success' : 'alert-danger');
                uploadStatus.textContent = message;
            };

            if (uploadForm && uploadFile && uploadBtn) {
                uploadForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (!uploadFile.files || uploadFile.files.length === 0) {
                        showUploadStatus('ËØ∑ÈÄâÊã©Ë¶Å‰∏ä‰º†ÁöÑÊñá‰ª∂„ÄÇ', 'danger');
                        return;
                    }

                    const formData = new FormData(uploadForm);
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', uploadForm.action);

                    const token = uploadForm.querySelector('input[name="__RequestVerificationToken"]')?.value;
                    if (token) {
                        xhr.setRequestHeader('RequestVerificationToken', token);
                    }

                    uploadBtn.disabled = true;
                    if (uploadProgressContainer && uploadProgressBar) {
                        uploadProgressContainer.classList.remove('d-none');
                        uploadProgressBar.style.width = '0%';
                        uploadProgressBar.textContent = '0%';
                    }

                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable && uploadProgressBar) {
                            const percent = Math.floor((event.loaded / event.total) * 100);
                            uploadProgressBar.style.width = `${percent}%`;
                            uploadProgressBar.textContent = `${percent}%`;
                        }
                    };

                    xhr.onerror = () => {
                        showUploadStatus('‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ', 'danger');
                        uploadBtn.disabled = false;
                    };

                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            showUploadStatus('‰∏ä‰º†ÊàêÂäüÔºåÊ≠£Âú®Âà∑Êñ∞ÂàóË°®...', 'success');
                            window.location.reload();
                        } else {
                            showUploadStatus('‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂ÊàñÈáçËØï„ÄÇ', 'danger');
                            uploadBtn.disabled = false;
                        }
                    };

                    xhr.send(formData);
                });
            }

            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
                    if (selected.length === 0) return;
                    if (!confirm(`Á°ÆÂÆöÊâπÈáè‰∏ãËΩΩÈÄâ‰∏≠ÁöÑ ${selected.length} ‰∏™Êñá‰ª∂Ôºü`)) return;
                    const form = document.getElementById('zip-form');
                    form?.submit();
                });
            }

            const downloadLinks = Array.from(document.querySelectorAll('.download-link'));
            downloadLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = link.getAttribute('data-download-url');
                    if (!url) return;
                    if (confirm('Á°ÆÂÆö‰∏ãËΩΩËØ•Êñá‰ª∂Ôºü')) {
                        window.location.href = url;
                    }
                });
            });

            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
                    if (selected.length === 0) return;
                    if (!confirm(`Á°ÆÂÆöÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selected.length} ‰∏™Êñá‰ª∂ÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`)) return;
                    if (deleteForm && deletePathsContainer) {
                        deletePathsContainer.innerHTML = '';
                        selected.forEach(val => {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = 'paths';
                            input.value = val;
                            deletePathsContainer.appendChild(input);
                        });
                        deleteForm.submit();
                    }
                });
            }

            updateState();
        });
    </script>
}
</div>
