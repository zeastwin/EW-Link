@page "/resources"
@model EW_Link.Pages.Resources.IndexModel
@using EW_Link.Services
@{
    ViewData["Title"] = "ËµÑÊ∫êÈó®Êà∑";
    string ActiveTab(ResourceTab tab) => Model.SelectedTab == tab ? "active" : string.Empty;
    var currentPathDisplay = string.IsNullOrWhiteSpace(Model.CurrentPath) ? "/" : Model.CurrentPath;
}

<div id="resource-page-content" class="resource-shell">
    <section class="glass-panel shadow-sm">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
            <div class="d-flex align-items-center gap-2">
                <a class="badge rounded-pill resource-tab-link tab-chip tab-chip-strong @ActiveTab(ResourceTab.Permanent)"
                   asp-page="/Resources/Index"
                   asp-route-tab="permanent"
                   asp-route-path="@Model.CurrentPath"
                   asp-route-q="@Model.Filter"
                   asp-route-sort="@Model.SortFieldParam"
                   asp-route-dir="@Model.SortDirectionParam">Ê∞∏‰πÖÊñá‰ª∂Â§π</a>
                <a class="badge rounded-pill resource-tab-link tab-chip tab-chip-strong @ActiveTab(ResourceTab.Temporary)"
                   asp-page="/Resources/Index"
                   asp-route-tab="temporary"
                   asp-route-path="@Model.CurrentPath"
                   asp-route-q="@Model.Filter"
                   asp-route-sort="@Model.SortFieldParam"
                   asp-route-dir="@Model.SortDirectionParam">‰∏¥Êó∂Êñá‰ª∂Â§π</a>
            </div>
            <div class="text-end small text-muted">
                <span class="me-3">ÁõÆÂΩïÊï∞Ôºö@Model.DirectoryCount</span>
                <span class="me-3">Êñá‰ª∂Êï∞Ôºö@Model.FileCount</span>
                <span>ÊÄªÂ§ßÂ∞èÔºö@Model.FormatSize(Model.TotalSize)</span>
            </div>
        </div>

        @if (TempData["SuccessMessage"] is string successMessage)
        {
            <div class="alert alert-success" role="alert">
                @successMessage
            </div>
        }
        @if (TempData["ErrorMessage"] is string errorMessage)
        {
            <div class="alert alert-danger" role="alert">
                @errorMessage
            </div>
        }
        @if (!ViewData.ModelState.IsValid)
        {
            <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>
        }

        <div class="d-flex flex-wrap align-items-center gap-2 mb-3 breadcrumb-bar">
            <div class="text-muted small">Ë∑ØÂæÑÔºö@currentPathDisplay</div>
        </div>

        <div class="action-panel row g-3 mb-3 align-items-center">
            <div class="col-12 col-lg-7 d-flex flex-wrap align-items-center gap-2">
                <form id="upload-form" method="post" enctype="multipart/form-data" asp-page-handler="Upload" class="d-flex flex-wrap align-items-center gap-2 flex-grow-1">
                    <input type="hidden" name="tab" value="@Model.SelectedTabString" />
                    <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
                    <input type="hidden" name="q" value="@Model.Filter" />
                    <input type="hidden" name="sort" value="@Model.SortFieldParam" />
                    <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
                    <div class="input-group flex-grow-1">
                        <input type="file" name="file" id="upload-file" class="form-control" />
                        <button type="submit" class="btn btn-success px-3" id="upload-submit">‰∏ä‰º†</button>
                    </div>
                </form>
            </div>
            <div class="col-12 col-lg-5">
                <form id="sort-form" method="get" class="d-flex flex-wrap align-items-center gap-2 justify-content-lg-end">
                    <input type="hidden" name="tab" value="@Model.SelectedTabString" />
                    <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
                    <input type="hidden" id="sort-hidden" name="sort" value="@Model.SortFieldParam" />
                    <input type="hidden" id="dir-hidden" name="dir" value="@Model.SortDirectionParam" />
                    <input class="form-control search-compact" type="search" name="q" placeholder="Êñá‰ª∂ÂêçËøáÊª§" value="@Model.Filter" />
                </form>
            </div>
        </div>

        <form id="create-folder-form" method="post" asp-page-handler="CreateDirectory" class="d-none">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
            <input type="hidden" name="q" value="@Model.Filter" />
            <input type="hidden" name="sort" value="@Model.SortFieldParam" />
            <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
            <input type="hidden" id="create-folder-name" name="folderName" />
        </form>

        <form method="post" asp-page-handler="DownloadZip" id="zip-form" class="resource-list-form">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
            <input type="hidden" name="q" value="@Model.Filter" />
            <input type="hidden" name="sort" value="@Model.SortFieldParam" />
            <input type="hidden" name="dir" value="@Model.SortDirectionParam" />

            <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                <a class="btn btn-return btn-sm back-link"
                   href="@Url.Page("/Resources/Index", new { tab = Model.SelectedTabString, path = Model.ParentPath, q = Model.Filter, sort = Model.SortFieldParam, dir = Model.SortDirectionParam })">‚¨Ö ËøîÂõû</a>
                <button type="button" class="btn btn-primary" id="download-zip-btn" disabled>ÊâπÈáè‰∏ãËΩΩ ZIP (0)</button>
                <button type="button" class="btn btn-outline-danger" id="delete-selected-btn" disabled>Âà†Èô§</button>
                <button type="button" class="btn btn-outline-secondary" id="move-selected-btn" disabled>ÁßªÂä®</button>
                <button type="button" class="btn btn-outline-dark" id="rename-selected-btn" disabled>ÈáçÂëΩÂêç</button>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="select-all" />
                    <label class="form-check-label" for="select-all">ÂÖ®ÈÄâ</label>
                </div>
                <button type="button" id="create-folder-btn" class="btn btn-outline-primary btn-sm">Êñ∞Âª∫Êñá‰ª∂Â§π</button>
                <div class="d-flex flex-wrap align-items-center gap-2 ms-auto">
                    <div class="btn-group compact-group" role="group" aria-label="Sort">
                        <button type="button" data-sort="name" class="btn btn-outline-primary sort-btn @(Model.SortFieldParam=="name"?"active":"")">ÂêçÁß∞</button>
                        <button type="button" data-sort="time" class="btn btn-outline-primary sort-btn @(Model.SortFieldParam=="time"?"active":"")">Êó∂Èó¥</button>
                        <button type="button" data-sort="size" class="btn btn-outline-primary sort-btn @(Model.SortFieldParam=="size"?"active":"")">Â§ßÂ∞è</button>
                    </div>
                    <div class="btn-group compact-group" role="group" aria-label="Dir">
                        <button type="button" data-dir="asc" class="btn btn-outline-secondary dir-btn @(Model.SortDirectionParam=="asc"?"active":"")">Âçá</button>
                        <button type="button" data-dir="desc" class="btn btn-outline-secondary dir-btn @(Model.SortDirectionParam=="desc"?"active":"")">Èôç</button>
                    </div>
                </div>
            </div>

            <div id="upload-status" class="alert d-none" role="alert"></div>
            <div id="upload-progress-container" class="progress mb-3 d-none">
                <div id="upload-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>

            <div class="list-group resource-list">
                @if (Model.Entries.Count == 0)
                {
                    <div class="list-group-item text-center text-muted py-4">ÂΩìÂâçÁõÆÂΩï‰∏∫Á©∫</div>
                }
                else
                {
                    @foreach (var entry in Model.Entries)
                    {
                        <div class="list-group-item d-flex align-items-center gap-3 resource-item @(entry.IsDirectory ? "directory-item" : string.Empty)"
                             data-url="@(entry.IsDirectory ? Url.Page("/Resources/Index", new { tab = Model.SelectedTabString, path = entry.RelativePath, q = Model.Filter, sort = Model.SortFieldParam, dir = Model.SortDirectionParam }) : string.Empty)">
                            <div class="form-check">
                                @if (entry.IsDirectory)
                                {
                                    <input class="form-check-input entry-checkbox" type="checkbox" name="paths" value="@entry.RelativePath" data-kind="dir" />
                                }
                                else
                                {
                                    <input class="form-check-input entry-checkbox" type="checkbox" name="paths" value="@entry.RelativePath" data-kind="file" />
                                }
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="resource-icon">@((entry.IsDirectory ? "üìÅ" : "üìÑ"))</span>
                                    <span class="fw-semibold text-primary">@entry.Name</span>
                                </div>
                                <div class="text-muted small">
                                    @if (entry.IsDirectory)
                                    {
                                        <span>ÁõÆÂΩï</span>
                                    }
                                    else
                                    {
                                        <span>@Model.FormatSize(entry.SizeBytes)</span>
                                    }
                                    <span class="ms-2">@entry.LastWriteTime.ToLocalTime().ToString("yyyy/MM/dd HH:mm")</span>
                                </div>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                @if (entry.IsDirectory)
                                {
                                    <a class="btn btn-outline-primary btn-sm"
                                       asp-page="/Resources/Index"
                                       asp-route-tab="@Model.SelectedTabString"
                                       asp-route-path="@entry.RelativePath"
                                       asp-route-q="@Model.Filter"
                                       asp-route-sort="@Model.SortFieldParam"
                                       asp-route-dir="@Model.SortDirectionParam">ËøõÂÖ•</a>
                                }
                                else
                                {
                                    <button type="button"
                                            class="btn btn-outline-secondary btn-sm preview-btn"
                                            data-preview-url="@Url.Page("/Resources/Index", "Preview", new { tab = Model.SelectedTabString, path = entry.RelativePath })"
                                            data-name="@entry.Name">È¢ÑËßà</button>
                                    <a class="btn btn-outline-primary btn-sm download-link"
                                       data-download-url="@Url.Page("/Resources/Index", "Download", new { tab = Model.SelectedTabString, path = entry.RelativePath })">‰∏ãËΩΩ</a>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        </form>
        <form method="post" asp-page-handler="Delete" id="delete-form" class="d-none">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
            <input type="hidden" name="q" value="@Model.Filter" />
            <input type="hidden" name="sort" value="@Model.SortFieldParam" />
            <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
            <div id="delete-paths-container"></div>
        </form>
        <form method="post" asp-page-handler="Move" id="move-form" class="d-none">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
            <input type="hidden" name="q" value="@Model.Filter" />
            <input type="hidden" name="sort" value="@Model.SortFieldParam" />
            <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
            <input type="hidden" name="targetDir" id="move-target-dir" />
            <div id="move-paths-container"></div>
        </form>
        <form method="post" asp-page-handler="Rename" id="rename-form" class="d-none">
            <input type="hidden" name="tab" value="@Model.SelectedTabString" />
            <input type="hidden" name="path" value="@(Model.CurrentPath ?? string.Empty)" />
            <input type="hidden" name="q" value="@Model.Filter" />
            <input type="hidden" name="sort" value="@Model.SortFieldParam" />
            <input type="hidden" name="dir" value="@Model.SortDirectionParam" />
            <input type="hidden" name="renamePath" id="rename-path" />
            <input type="hidden" name="newName" id="rename-new-name" />
        </form>
    </section>
</div>

<div class="modal fade" id="preview-modal" tabindex="-1" aria-labelledby="preview-modal-title" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="preview-modal-title">Êñá‰ª∂È¢ÑËßà</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="preview-loading" class="text-muted">Âä†ËΩΩ‰∏≠...</div>
                <div id="preview-message" class="alert alert-warning d-none"></div>
                <div id="preview-content" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function initResourcePage(root) {
            const container = root || document;
            const selectAll = container.querySelector('#select-all');
            const checkboxes = Array.from(container.querySelectorAll('.entry-checkbox'));
            const downloadBtn = container.querySelector('#download-zip-btn');
            const deleteBtn = container.querySelector('#delete-selected-btn');
            const moveBtn = container.querySelector('#move-selected-btn');
            const renameSelectedBtn = container.querySelector('#rename-selected-btn');
            const deleteForm = container.querySelector('#delete-form');
            const deletePathsContainer = container.querySelector('#delete-paths-container');
            const moveForm = container.querySelector('#move-form');
            const movePathsContainer = container.querySelector('#move-paths-container');
            const moveTargetDir = container.querySelector('#move-target-dir');
            const renameForm = container.querySelector('#rename-form');
            const renamePath = container.querySelector('#rename-path');
            const renameNewName = container.querySelector('#rename-new-name');
            const uploadForm = container.querySelector('#upload-form');
            const uploadFile = container.querySelector('#upload-file');
            const uploadBtn = container.querySelector('#upload-submit');
            const uploadStatus = container.querySelector('#upload-status');
            const uploadProgressContainer = container.querySelector('#upload-progress-container');
            const uploadProgressBar = container.querySelector('#upload-progress-bar');
            const sortForm = container.querySelector('#sort-form');
            const sortHidden = container.querySelector('#sort-hidden');
            const dirHidden = container.querySelector('#dir-hidden');
            const sortButtons = Array.from(container.querySelectorAll('.sort-btn'));
            const dirButtons = Array.from(container.querySelectorAll('.dir-btn'));
            const createFolderForm = container.querySelector('#create-folder-form');
            const createFolderBtn = container.querySelector('#create-folder-btn');
            const createFolderName = container.querySelector('#create-folder-name');
            const previewButtons = Array.from(container.querySelectorAll('.preview-btn'));
            const previewModalEl = document.getElementById('preview-modal');
            const previewTitle = document.getElementById('preview-modal-title');
            const previewContent = document.getElementById('preview-content');
            const previewMessage = document.getElementById('preview-message');
            const previewLoading = document.getElementById('preview-loading');
            const previewModal = window.bootstrap && previewModalEl ? new bootstrap.Modal(previewModalEl) : null;

            const updateState = () => {
                const selectedItems = checkboxes.filter(cb => cb.checked);
                const selected = selectedItems.length;
                if (downloadBtn) {
                    downloadBtn.textContent = `ÊâπÈáè‰∏ãËΩΩ ZIP (${selected})`;
                    downloadBtn.disabled = selected === 0;
                }
                if (deleteBtn) {
                    deleteBtn.disabled = selected === 0;
                }
                if (moveBtn) {
                    moveBtn.disabled = selected === 0;
                }
                if (renameSelectedBtn) {
                    renameSelectedBtn.disabled = selected !== 1;
                }
                if (selectAll) {
                selectAll.indeterminate = selected > 0 && selected < checkboxes.length;
                selectAll.checked = selected > 0 && selected === checkboxes.length;
            }
        };

            checkboxes.forEach(cb => cb.addEventListener('change', updateState));
            if (selectAll) {
                selectAll.addEventListener('change', () => {
                    checkboxes.forEach(cb => {
                        cb.checked = selectAll.checked;
                    });
                    updateState();
                });
            }

            const showUploadStatus = (message, type) => {
                if (!uploadStatus) return;
                uploadStatus.classList.remove('d-none', 'alert-success', 'alert-danger');
                uploadStatus.classList.add(type === 'success' ? 'alert-success' : 'alert-danger');
                uploadStatus.textContent = message;
            };

            if (uploadForm && uploadFile && uploadBtn) {
                uploadForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (!uploadFile.files || uploadFile.files.length === 0) {
                        showUploadStatus('ËØ∑ÈÄâÊã©Ë¶Å‰∏ä‰º†ÁöÑÊñá‰ª∂„ÄÇ', 'danger');
                        return;
                    }
                    const formData = new FormData(uploadForm);
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', uploadForm.action);
                    const token = uploadForm.querySelector('input[name="__RequestVerificationToken"]')?.value;
                    if (token) xhr.setRequestHeader('RequestVerificationToken', token);
                    uploadBtn.disabled = true;
                    if (uploadProgressContainer && uploadProgressBar) {
                        uploadProgressContainer.classList.remove('d-none');
                        uploadProgressBar.style.width = '0%';
                        uploadProgressBar.textContent = '0%';
                    }
                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable && uploadProgressBar) {
                            const percent = Math.floor((event.loaded / event.total) * 100);
                            uploadProgressBar.style.width = `${percent}%`;
                            uploadProgressBar.textContent = `${percent}%`;
                        }
                    };
                    xhr.onerror = () => {
                        showUploadStatus('‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ', 'danger');
                        uploadBtn.disabled = false;
                    };
                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            showUploadStatus('‰∏ä‰º†ÊàêÂäüÔºåÊ≠£Âú®Âà∑Êñ∞ÂàóË°®...', 'success');
                            window.location.reload();
                        } else {
                            showUploadStatus('‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂ÊàñÈáçËØï„ÄÇ', 'danger');
                            uploadBtn.disabled = false;
                        }
                    };
                    xhr.send(formData);
                });
            }

            if (createFolderForm && createFolderBtn && createFolderName) {
                createFolderBtn.addEventListener('click', () => {
                    const name = prompt('ËØ∑ËæìÂÖ•Êñ∞Êñá‰ª∂Â§πÂêçÁß∞');
                    if (!name) return;
                    const trimmed = name.trim();
                    if (!trimmed) return;
                    createFolderName.value = trimmed;
                    createFolderForm.submit();
                });
            }

            const formatBytes = (size) => {
                if (size === undefined || size === null || Number.isNaN(Number(size))) return '';
                let value = Number(size);
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let unitIndex = 0;
                while (value >= 1024 && unitIndex < units.length - 1) {
                    value /= 1024;
                    unitIndex++;
                }
                return `${value.toFixed(value >= 10 ? 0 : 2)} ${units[unitIndex]}`;
            };

            const showPreviewMessage = (message) => {
                if (!previewMessage) return;
                previewMessage.textContent = message;
                previewMessage.classList.remove('d-none');
            };

            const resetPreview = (title) => {
                if (previewTitle && title) previewTitle.textContent = title;
                if (previewContent) previewContent.innerHTML = '';
                if (previewMessage) previewMessage.classList.add('d-none');
                if (previewLoading) previewLoading.classList.remove('d-none');
            };

            const openPreviewModal = () => {
                if (previewModal) {
                    previewModal.show();
                    return;
                }
                if (previewModalEl) {
                    previewModalEl.classList.add('show', 'd-block');
                }
            };

            const renderPreview = (data) => {
                if (!previewContent || !data) return;
                previewLoading?.classList.add('d-none');
                previewMessage?.classList.add('d-none');
                const kind = data.kind;
                if (!data.success) {
                    showPreviewMessage(data.message || 'È¢ÑËßàÂ§±Ë¥•„ÄÇ');
                    return;
                }
                if (kind === 'text') {
                    const pre = document.createElement('pre');
                    pre.className = 'bg-light p-3 rounded border preview-text';
                    pre.textContent = data.content || '';
                    previewContent.appendChild(pre);
                    return;
                }
                if (kind === 'image') {
                    const img = document.createElement('img');
                    img.src = data.previewUrl;
                    img.alt = 'È¢ÑËßàÂõæÁâá';
                    img.className = 'img-fluid';
                    previewContent.appendChild(img);
                    return;
                }
                if (kind === 'audio') {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.className = 'w-100';
                    const source = document.createElement('source');
                    source.src = data.previewUrl;
                    audio.appendChild(source);
                    previewContent.appendChild(audio);
                    return;
                }
                if (kind === 'video') {
                    const video = document.createElement('video');
                    video.controls = true;
                    video.className = 'w-100';
                    video.style.maxHeight = '70vh';
                    const source = document.createElement('source');
                    source.src = data.previewUrl;
                    video.appendChild(source);
                    previewContent.appendChild(video);
                    return;
                }
                if (kind === 'pdf') {
                    const frame = document.createElement('iframe');
                    frame.src = data.previewUrl;
                    frame.className = 'w-100 border';
                    frame.style.minHeight = '480px';
                    previewContent.appendChild(frame);
                    return;
                }
                if (kind === 'zip') {
                    const info = document.createElement('div');
                    info.className = 'small text-muted mb-2';
                    info.textContent = data.truncated ? '‰ªÖÊòæÁ§∫Ââç 200 Êù°„ÄÇ' : 'ÂÖ®ÈÉ®Êù°ÁõÆ„ÄÇ';
                    previewContent.appendChild(info);
                    const list = document.createElement('ul');
                    list.className = 'list-group preview-zip-list';
                    (data.entries || []).forEach(e => {
                        const item = document.createElement('li');
                        item.className = 'list-group-item d-flex justify-content-between align-items-center';
                        const name = document.createElement('span');
                        name.textContent = e.name || '';
                        const size = document.createElement('span');
                        size.className = 'badge bg-secondary rounded-pill';
                        size.textContent = formatBytes(e.size);
                        item.appendChild(name);
                        item.appendChild(size);
                        list.appendChild(item);
                    });
                    previewContent.appendChild(list);
                    return;
                }

                showPreviewMessage('ÊöÇ‰∏çÊîØÊåÅËØ•Êñá‰ª∂Á±ªÂûãÈ¢ÑËßà„ÄÇ');
            };

            const loadPreview = (url, name) => {
                if (!url) return;
                resetPreview(name || 'È¢ÑËßà');
                openPreviewModal();
                fetch(url, { headers: { 'X-Requested-With': 'Fetch', 'Accept': 'application/json' } })
                    .then(res => res.ok ? res.json() : Promise.reject())
                    .then(data => renderPreview(data))
                    .catch(() => {
                        previewLoading?.classList.add('d-none');
                        showPreviewMessage('È¢ÑËßàÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ');
                    });
            };

            previewButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = btn.getAttribute('data-preview-url');
                    const name = btn.getAttribute('data-name') || 'È¢ÑËßà';
                    loadPreview(url, name);
                });
            });

            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked);
                    if (selected.length === 0) {
                        alert('ËØ∑ÈÄâÊã©Ë¶Å‰∏ãËΩΩÁöÑÊñá‰ª∂ÊàñÊñá‰ª∂Â§π„ÄÇ');
                        return;
                    }
                    // Áõ¥Êé•Êèê‰∫§Â∑≤ÂãæÈÄâÁöÑË∑ØÂæÑÔºåÂåÖÂê´Êñá‰ª∂‰∏éÊñá‰ª∂Â§π
                    const form = container.querySelector('#zip-form');
                    if (!form) return;
                    form.submit();
                });
            }

            const downloadLinks = Array.from(container.querySelectorAll('.download-link'));
            downloadLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = link.getAttribute('data-download-url');
                    if (!url) return;
                    if (confirm('Á°ÆÂÆö‰∏ãËΩΩËØ•Êñá‰ª∂Ôºü')) {
                        window.location.href = url;
                    }
                });
            });

            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
                    if (selected.length === 0) return;
                    if (!confirm(`Á°ÆÂÆöÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selected.length} ‰∏™Êñá‰ª∂ÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`)) return;
                    if (deleteForm && deletePathsContainer) {
                        deletePathsContainer.innerHTML = '';
                        selected.forEach(val => {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = 'paths';
                            input.value = val;
                            deletePathsContainer.appendChild(input);
                        });
                        deleteForm.submit();
                    }
                });
            }

            if (moveBtn) {
                moveBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
                    if (selected.length === 0) return;
                    const target = prompt('ËØ∑ËæìÂÖ•ÁõÆÊ†áÁõÆÂΩïÔºàÁõ∏ÂØπË∑ØÂæÑÔºåÊ†πÁõÆÂΩïÁïôÁ©∫ÔºâÔºö', '');
                    if (target === null) return;
                    if (!moveForm || !movePathsContainer || !moveTargetDir) return;
                    movePathsContainer.innerHTML = '';
                    selected.forEach(val => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'paths';
                        input.value = val;
                        movePathsContainer.appendChild(input);
                    });
                    moveTargetDir.value = target.trim();
                    moveForm.submit();
                });
            }

            if (renameSelectedBtn) {
                renameSelectedBtn.addEventListener('click', () => {
                    const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
                    if (selected.length !== 1) return;
                    const path = selected[0];
                    const name = path.split('/').pop() || path;
                    if (!renameForm || !renamePath || !renameNewName) return;
                    const newName = prompt('ËØ∑ËæìÂÖ•Êñ∞ÂêçÁß∞Ôºà‰∏çÂê´Ë∑ØÂæÑÂàÜÈöîÁ¨¶ÔºâÔºö', name);
                    if (!newName) return;
                    const trimmed = newName.trim();
                    if (!trimmed) return;
                    renamePath.value = path;
                    renameNewName.value = trimmed;
                    renameForm.submit();
                });
            }


            const tabLinks = Array.from(container.querySelectorAll('.resource-tab-link'));
            const contentRoot = document.getElementById('resource-page-content');
            const directoryItems = Array.from(container.querySelectorAll('.directory-item[data-url]'));
            const backLinks = Array.from(container.querySelectorAll('.back-link'));
            const loadPage = (url, push) => {
                if (!contentRoot) return;
                fetch(url, { headers: { 'X-Requested-With': 'Fetch' } })
                    .then(res => res.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newContent = doc.getElementById('resource-page-content');
                        if (newContent) {
                            contentRoot.innerHTML = newContent.innerHTML;
                            if (push) history.pushState({}, '', url);
                            initResourcePage(contentRoot);
                        }
                    })
                    .catch(err => console.warn('Â±ÄÈÉ®Âä†ËΩΩÂ§±Ë¥•Ôºö', err));
            };

            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = link.getAttribute('href');
                    if (!url) return;
                    loadPage(url, true);
                });
            });

            directoryItems.forEach(item => {
                item.addEventListener('dblclick', () => {
                    const url = item.getAttribute('data-url');
                    if (!url) return;
                    loadPage(url, true);
                });
            });

            backLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = link.getAttribute('href');
                    if (!url) return;
                    loadPage(url, true);
                });
            });

            window.onpopstate = () => loadPage(location.href, false);

            sortButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    sortButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    if (sortHidden) sortHidden.value = btn.dataset.sort;
                    if (sortForm) sortForm.submit();
                });
            });

            dirButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    dirButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    if (dirHidden) dirHidden.value = btn.dataset.dir;
                    if (sortForm) sortForm.submit();
                });
            });

            if (sortForm) {
                sortForm.addEventListener('submit', (e) => {
                    // ensure hidden values are aligned; active classes already set
                    const activeSort = sortButtons.find(b => b.classList.contains('active'));
                    const activeDir = dirButtons.find(b => b.classList.contains('active'));
                    if (activeSort && sortHidden) sortHidden.value = activeSort.dataset.sort;
                    if (activeDir && dirHidden) dirHidden.value = activeDir.dataset.dir;
                });
            }
            updateState();
        }

        window.addEventListener('DOMContentLoaded', () => initResourcePage(document));
    </script>
}
